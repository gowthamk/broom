%% ************ MACROS *************
\newcommand{\hdOf}[2]{\C{class}\; #1\angAlpha\inang{\rhobar \,|\, #2} \extends \fbN}

% mathpartir's inferrule: seems to have problems with linebreaks
%% \newcommand{\genconstraint}[2]{\inferrule*{#1}{#2}}
%% \newcommand{\gcarrow}{\leadsto}
%% \newcommand{\gctransforms}{\models}

%% \newcommand{\gcrule}[2]{%
%% \begin{smathpar}\begin{array}{c}%
%% \renewcommand*{\arraystretch}{1.2}%
%% \RULE {#1} {#2}%
%% \end{array}\end{smathpar}%
%% }

% \newcommand{\SRULE}[2]{\frac{\begin{array}{c}\renewcommand*{\arraystretch}{1.5} #1\end{array}}
%                            {\begin{array}{c}\renewcommand*{\arraystretch}{1.5} #2\end{array}}}
\newcommand{\SRULE}[2]{\frac{\begin{array}{c} #1 \end{array}}{\begin{array}{c} #2 \end{array}}}

\newcommand{\beginrules}{%
\renewcommand*{\arraystretch}{1.2}%
\begin{smathpar}\begin{array}{lc}%
}
\newcommand{\myendrules}{\end{array}\end{smathpar}}

\newcommand{\lgcrule}[3]{%
[\rulelabel{#1}] & \SRULE {#2} {#3}%
\\[0.2cm]%
}

\newcommand{\lgcfact}[2]{%
[\rulelabel{#1}] & {#2} %
\\[0.2cm]%
}

\newcommand{\nl}{\\}

\newcommand{\subtypesym}{<:}
\newcommand{\typeok}[3]{{#1\,\vdash\,#2 \; \texttt{ok} \, \lhd #3}}
\newcommand{\exprok}[4]{{#1} \, \vdash \, {#2} : {#3} \, \lhd {#4}}
\newcommand{\subtypeok}[4]{{#1} \, \vdash \, {#2}  \subtypesym {#3} \, \lhd {#4}} 
\newcommand{\stdcontext}{\A,\env}

%% ************ END MACROS *************

\begin{figure*}[t!]

%%%%%%%%%%% Header Box %%%%%%%%%%%
\fbox{  \( \exprok{\stdcontext}{e}{\tau}{C} \)}
\\

\beginrules

%%%%%%%%%%% () and x %%%%%%%%%%%
\lgcfact{UNIT}{\exprok{\stdcontext}{\unitval}{\unitZ}{\{\}}}

\lgcfact{VAR}{\exprok{\stdcontext}{x}{\env(\tau)}{\{\}}}

% \begin{minipage}{1.2in}
% \begin{smathpar}
% \begin{array}{l}
% \renewcommand*{\arraystretch}{1.2}
% \exprok{\stdcontext}{\unitval}{\unitZ}{\{\}} \\
% \exprok{\stdcontext}{x}{\env(\tau)}{\{\}}
% \end{array}
% \end{smathpar}
% \end{minipage}

%%%%%%%%%%% FIELD-ACCESS: e.f %%%%%%%%%%%
\lgcrule{FIELD-ACCESS}
  {
    \exprok{\stdcontext}{e}{\tau'}{C} \spc
    \bar{f}:\taubar \,=\, \fields(\bound_{\A.\aenv}(\tau'))
  }
  {
    \exprok{\stdcontext}{e.f_i}{\tau_i}{C}
  }

%%%%%%%%%%% NEW %%%%%%%%%%%
  \lgcrule{NEW}
  {
    \typeok {\A} {\fbN} {C_1} \spc
    \exprok {\stdcontext} {\bar{e}} {\bar{\tau'}} {C_2}
    %% \spc C_3 = \{ \isvalid{\A.\phicx}{\allocRgn(\fbN)=\ralloc} \}
    \nl
    \fields(\fbN) = \bar{f} : \taubar \spc
    \subtypeok {\A} {\bar{\tau'}} {\bar{\tau}} {C_3}
  }
  {
    \exprok {\stdcontext}   {\C{new} \fbN(\bar{e})} {\fbN} {\cup_{i=1}^3 C_i}
  }

%%%%%%%%%%% LET %%%%%%%%%%%
  \lgcrule{LET}
  {
    \exprok{\stdcontext}{e_1}{\tau_1}{C_1} \spc
    \exprok{\A,{\env[x\mapsto\tau_1]}}{e_2}{\tau_2}{C_2} \\
  }
  {
    \exprok{\stdcontext}{\letexp{x}{e_1}{e_2}}{\tau_2}{C_1 \cup C_2}
  }

%%%%%%%%%%% NEW-REGION %%%%%%%%%%%
  \lgcrule{NEW-REGION}
  {
    \typeok {\A.\aenv} {T} {C_1} \spc
    \rgn \in \A.\rhoenv
    \nl
    \exprok{(\{\rho\},\A.\aenv,true),{\cdot}}{e}{T@\rho}{C_2}
  }
  {
    \exprok {\stdcontext} {\C{new}\; \RgnZ\inang{T} \inang{\toprgn} (\lambdaexp{\rgn}{\rho}{}{e})}
        {\RgnZ\inang{T} \inang{\toprgn}} {C_1 \cup C_2}
  }

%%%%%%%%%%% METHOD-INV %%%%%%%%%%%
  \lgcrule{METHOD-INV}
  {
    \exprok {\stdcontext} {e_0} {\tau} {C_1} \spc C_4 = \{ \rbar \in \A.\rhoenv \}
    \nl
    \mtype(m,\bound_{\A.\aenv}(\tau)) = \inang{\rhobar \,|\, \phi}\bar{\tau^1}\rightarrow{\tau^2}
    \nl
%   \substFn = [\rbar/\rhobar] \\
    \typeok {\A} {\inang{\rhobar \,|\,\phi}\bar{\tau^1}\rightarrow{\tau^2}} {C_2}
       \spc
       \exprok {\stdcontext} {\bar{e}} {[\rbar/\rhobar](\bar{\tau^1})} {C_3}
    \nl
%   \subtyp{\A}{\bar{\tau'}}{\substFn(\bar{\tau^1})} \spc
    C_5 = \{ \isvalid{\A.\phicx}{[\rbar/\rhobar](\phi)} \}
  }
  {
    \exprok {\stdcontext} {e_0.m\inang{\rbar}(\bar{e})} 
       {[\rbar/\rhobar](\tau^2)} {C_1 \cup C_2 \cup C_3 \cup C_4 \cup C_5}
  }

%%%%%%%%%%% LET-REGION %%%%%%%%%%%

\lgcrule{LET-REGION}{
   \A = (\rhoenv,\aenv,\phicx)  \spc \rgn \notin \rhoenv \spc
      \A' = (\rhoenv \cup \{\rgn\}, \aenv, \phicx \conj (\rhoenv \outlives \rgn))
   \nl
   \exprok{\A',\env} {e_a} {\tau} {C_1} \spc
      \typeok {\A} {\tau} {C_2}
}{
   \exprok{\stdcontext} {\letregion{\rgn}{e_a}} {\tau} {(C_1 \cup C_2)}
}

\myendrules

\caption{Constraint generation}
\label{fig:constraint-gen-0}
\end{figure*}

