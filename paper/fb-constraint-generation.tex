%% ************ MACROS *************
% \newcommand{\hdOf}[2]{\C{class}\; #1\angAlpha\inang{\rhoalloc \rhobar \,|\, #2} \extends \fbN}

% mathpartir's inferrule: seems to have problems with linebreaks

\newcommand{\rulepart}[1]{%
\begingroup%
\renewcommand*{\arraystretch}{1.2}%
\begin{array}{c} #1 \end{array}%
\endgroup%
}

\newcommand{\SRULE}[2]{\frac{\rulepart{#1}}{\rulepart{#2}}}

\newcommand{\beginrules}{%
\renewcommand*{\arraystretch}{1.4}%
\begin{smathpar}\begin{array}{lc}%
}
\newcommand{\myendrules}{\end{array}\end{smathpar}}

\newcommand{\lgcrule}[3]{%
[\rulelabel{#1}] & \SRULE {#2} {#3}%
\\[0.5cm] % \\[0.3cm]%
}

\newcommand{\lgcfact}[2]{%
[\rulelabel{#1}] & {#2} %
\\[0.3cm] % \\[0.2cm]%
}

\newcommand{\nl}{\\}

\newcommand{\subtypesym}{<:}
\newcommand{\okinok}[3]{{\vdash\,#1 \; \texttt{ok} \; \texttt{in} \; #2 \, \lhd #3}}
\newcommand{\typeok}[3]{{#1\,\vdash\,#2 \; \texttt{ok} \, \lhd #3}}
\newcommand{\exprok}[4]{{#1} \, \vdash \, {#2} : {#3} \, \lhd {#4}}
\newcommand{\subtypeok}[4]{{#1} \, \vdash \, {#2}  \subtypesym {#3} \, \lhd {#4}} 
\newcommand{\stdcontext}{\A,\env,r}

%% ************ END MACROS *************

\begin{figure*}[t!]

%%%%%%%%%%% Header Box %%%%%%%%%%%
  \textbf{Expression Typing Constraint Generation} \; \fbox{  \( \exprok{\stdcontext}{e}{\tau}{C} \)}
\\

\beginrules

%%%%%%%%%%% NEW %%%%%%%%%%%
  \lgcrule{New}
  {
    \exprok {\stdcontext} {\bar{e}} {\bar{\tau}} {C_1}
    \spc
    \typeok {\A} {\fbN} {C_2}
    \spc
    %% \spc C_3 = \{ \isvalid{\A.\phicx}{\allocRgn(\fbN)=\ralloc} \}
    \fields(\fbN) = \bar{f} : \taubar
% \spc \subtypeok {\A} {\bar{\tau'}} {\bar{\tau}} {C_3}
  }
  {
    \exprok {\stdcontext}   {\C{new} \fbN(\bar{e})} {\fbN} {C_1 \cup C_2}
  }

%%%%%%%%%%% NEW-REGION %%%%%%%%%%%
  \lgcrule{NewRegion}
  {
    % \typeok {\A.\aenv} {T} {C_1} \spc
    % C_1 = \{ \rgn \in \A.\rhoenv \}
   % \spc
   \exprok {\stdcontext} {e} {\inang{\rho} \unitZ \xrightarrow{r} T@\rho} {C}
    % \nl
    % \exprok{(\{\rho\},\A.\aenv,true),{\cdot}}{e}{T@\rho}{C_2}
  }
  {
    % \exprok {\stdcontext} {\C{new}\; \RgnZ\inang{T} \inang{\toprgn} (\lambdaexp{\rgn}{\rho}{}{e})}  {\RgnZ\inang{T} \inang{\toprgn}} {C_1 \cup C_2}
    \exprok {\stdcontext} {\C{new}\; \RgnZ\inang{T} \inang{\toprgn} (e)}  {\RgnZ\inang{T} \inang{\toprgn}} {C}
  }

%%%%%%%%%%% LET-REGION %%%%%%%%%%%

\lgcrule{LetRegion}{
   \A = (\rhoenv,\aenv,\phicx)  \spc \rgn \notin \rhoenv \spc
      \A' = (\rhoenv \cup \{\rgn\}, \aenv, \phicx \conj (\rhoenv \outlives \rgn))
   \nl
   \exprok{\A',\env,\rgn} {e} {\tau} {C_1} \spc
      \typeok {\A} {\tau} {C_2}
}{
   \exprok{\stdcontext} {\letregion{\rgn}{e}} {\tau} {(C_1 \cup C_2)}
}

%%%%%%%%%%% FUNCTION INVOCATION %%%%%%%%%%%
\lgcrule{FnApply}
{
C_1 = \{\bar{\pi} \in \A.\rhoenv\} \spc
\exprok {\stdcontext} {e} {\inang{\rhobar\,|\,\phi}\bar{\tau^1} \xrightarrow{\rgn} \tau^2} {C_2}
\nl
C_3 = \{\isvalid{\A.\phicx}{[\bar{\pi}/\rhobar]\phi}\} \spc
\exprok {\stdcontext} {\bar{e}} {[\bar{\pi}/\bar{\rho}] \bar{\tau^1}} {C_4}
% \spc \substFn = [\bar{\pi}/\rhobar]
% \spc
% \subtypeok {\A} {\bar{\tau'}} {\substFn(\bar{\tau})} {C_5}
}{
\exprok {\stdcontext} {e\inang{\bar{\pi}}(\bar{e})} {[\bar{\pi}/\bar{\rho}] \tau^2} {\cup_{i=1}^4 C_i}
}

%%%%%%%%%%% OPEN-REGION %%%%%%%%%%%
\lgcrule{Open}{
   \exprok {\stdcontext} {e_a} {\RgnZ\inang{T}\inang{\toprgn}} {C_1} \spc
   \A = (\rhoenv,\aenv,\phicx) \spc
   \rgn \notin \rhoenv
   \\
   % (\A',\env') = ((\rhoenv \cup \{\rgn\},\aenv,\phicx),\env[y\mapsto T@\rgn] \spc
   \exprok {(\rhoenv \cup \{\rgn\},\aenv,\phicx),\env[y\mapsto T@\rgn]} {e_b} {\tau} {C_2}
\spc
\typeok {\A} {\tau} {C_3}
}{
   \exprok {\stdcontext} {\open{e_a}{\rgn}{y}{e_b}} {\tau} {(C_1 \cup C_2 \cup C_3)}
}

\myendrules

\caption{Constraint generation rules: Part 1}
\label{fig:constraint-gen-0}
\end{figure*}

