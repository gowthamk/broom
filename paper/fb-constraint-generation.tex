\newcommand{\hdOf}[2]{\C{class}\; #1\angAlpha\inang{\rhoalloc\rhobar \,|\, #2} \extends \fbN}

% mathpartir's inferrule: seems to have problems with linebreaks
\newcommand{\genconstraint}[2]{\inferrule*{#1}{#2}}
\newcommand{\gcarrow}{\leadsto}
\newcommand{\gctransforms}{\models}

\newcommand{\gcrule}[2]{%
\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
\RULE {#1} {#2}%
\end{array}\end{smathpar}%
}

\newcommand{\lgcrule}[3]{%
\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
[\rulelabel{#1}] \spc \RULE {#2} {#3}%
\end{array}\end{smathpar}%
}

\newcommand{\minigcrule}[3]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
\RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}

\newcommand{\subtypesym}{<:}

\newcommand{\typeok}[3]{{#1\,\vdash\,#2 \; \texttt{ok} \, \lhd #3}}
\newcommand{\exprok}[4]{{#1} \, \vdash \, {#2} : {#3} \, \lhd {#4}}
\newcommand{\subtypeok}[4]{{#1} \, \vdash \, {#2}  \subtypesym {#3} \, \lhd {#4}} 

\newcommand{\stdcontext}{\exptycx{\ralloc}{\env}}

\begin{figure*}[t]
% \begin{mathpar}
\fbox{  \(
    \typeok{\A}{\tau}{C}, \spc
    \exprok{\stdcontext}{e}{\tau}{C}
%   \tywf{\rhoenv}{\phi}
  \)}
\\

% NEW
  \lgcrule{NEW}
  {
    \typeok {\A} {\fbN} {C_1} \spc
    \exprok {\stdcontext} {\bar{e}} {\bar{\tau'}} {C_2} \spc
    C_3 = \{ \isvalid{\A.\phicx}{\allocRgn(\fbN)=\ralloc} \} \spc
    \fields(\fbN) = \bar{f} : \taubar \spc
    \subtypeok {\A} {\bar{\tau'}} {\bar{\tau}} {C_4}
  }
  {
    \exprok {\stdcontext}   {\C{new} \fbN(\bar{e})} {\fbN} {\cup_{i=1}^4 C_i}
  }

% FUNCTION INVOCATION
\lgcrule{FUN-APPLY}
{
\exprok {\stdcontext} {e_a} {\inang{\rho_0 \rhobar\,|\,\phi}\taubar \xrightarrow{\rgn} \tau} {C_1} \spc
\exprok {\stdcontext} {\bar{e}} {\bar{\tau'}} {C_2} \spc
\substFn = [\bar{\rho'}/\rhobar][\rho_0'/\rho_0]
\\
C_3 = \{\rho_0' \bar{\rho'} \in \A.\rhoenv\} \spc
C_4 = \{\isvalid{\A.\phicx}{\substFn(\phi)}\} \spc
\subtypeok {\A} {\bar{\tau'}} {\substFn(\bar{\tau})} {C_5}
}{
\exprok {\stdcontext} {e_a\inang{\rho_0'\bar{\rho'}}(\bar{e})} {\tau} {\cup_{i=1}^5 C_i}
}

% Original from elaboration algorithm:
% $e_a(\bar{e})$ $\longrightarrow$ 
%    let ($e_a':\inang{\rhoalloc\rhobar\,|\,\phi}\taubar \xrightarrow{\rgn} \tau$,$C_1$) = 
%                $\elabExpr(\A,\ralloc,\env,e_a)$ in
%    let $\bar{\rho'}$ = $\bar{\fresh_\rho()}$ in
%    let $C_2$ = $\{\bar{\rho'} \in \A.\rhoenv\}$ in
%    let $\substFn$ = $[\bar{\rho'}/\rhobar][\ralloc/\rhoalloc]$ in
%    let $C_3$ = $\{\isvalid{\A.\phicx}{\substFn(\phi)}\}$ in
%%*   %let $(C_3,C_4)$ = $(\typeOk(\substFn(\taubar)), \typeOk(\substFn(\tau)))$ in 
%*)   let $(\bar{e'}:\bar{\tau'}, C_4)$ = $\elabExpr(\A,\ralloc,\env,\bar{e})$ in
%    let $C_5$ = $\subtypeOk({\A},{\bar{\tau'}},{\bar{\substFn(\tau)}})$ in
%      ($e_a'\inang{\ralloc\bar{\rho'}}(\bar{e'}):\substFn(\tau)$,$\bigcup_{i=1}^5 C_i$)

% LET-REGION
\lgcrule{LET-REGION}{
\A= (\rhoenv,\aenv,\phicx)  \spc
\rgn \notin \rhoenv \spc
\A' = (\rhoenv \cup \{\rgn\}, \aenv, \phicx \conj (\rhoenv \outlives \rgn))  \spc
\exprok{\A',\rgn,\env} {e_a} {\tau} {C_1} \spc
\typeok {\A} {\tau} {C_2}
}{
\exprok{\stdcontext} {\letregion{\rgn}{e_a}} {\tau} {(C_1 \cup C_2)}
}

% Original from elaboration algorithm:
%  | $\letregion{\rgn}{e_a}$ $\longrightarrow$
%    let $\rgn'$ = $\fresh_{\rgn}()$ in 
%    let $(\rhoenv,\aenv,\phicx)$ = $\A$ in
%    let $\A'$ = ($\rhoenv \cup \{\rgn'\}, \aenv, \phicx \conj (\rhoenv \outlives \rgn')$) in
%    let ($e_a':\tau$,$C_1$) = $\elabExpr(\A',\rgn',\env,[\rgn'/\rgn]e_a)$ in
%      ($\letregion{\rgn'}{e_a'}:\tau$,$C_1$)

% OPEN-REGION
\lgcrule{OPEN}{
\exprok {\stdcontext} {e_a} {\RgnZ\inang{T}\inang{\rho}} {C_1} \spc
\A = (\rhoenv,\aenv,\phicx) \spc
\rgn \notin \rhoenv \spc
(\A',\env') = ((\rhoenv \cup \{\rgn\},\aenv,\phicx),\env[y\mapsto T@\rgn] \spc
\exprok {\A',\rgn,\env'} {e_b} {\tau} {C_2}
}{
\exprok {\stdcontext} {\open{e_a}{\rgn}{y}{e_b}} {\tau} {(C_1 \cup C_2)}
}

% Original from elaboration algorithm:
%  | $\open{e_a}{\rgn}{y}{e_b}$ $\longrightarrow$ 
%    let ($e_a':\RgnZ\inang{T}\inang{\rho}$,$C_1$) = 
%                $\elabExpr(\A,\ralloc,\env,e_a)$ in
%    let $\rgn'$ = $\fresh_{\rgn}()$ in 
%    let $(\rhoenv,\aenv,\phicx)$ = $\A$ in
%    let ($\A'$,$\env'$) = ($(\rhoenv \cup \{\rgn'\},\aenv,\phicx)$,$\env[y\mapsto T@\rgn']$) in
%    let ($e_b':\tau$,$C_2$) = $\elabExpr(\A',\rgn',\env',[\rgn'/\rgn]e_a)$ in
%      ($\open{e_a'}{\rgn'}{y}{e_b'} : \tau$, $C_1 \cup C_2$)

% 
% METHOD OK
\lgcrule{METHOD}{
CT(B) = \hdOf{B}{\varphi}\{\bar{\tau^f}\,\xbar;\;\bar{d}\} \\
\A = (\rhoenv,\aenv,\phicx) = (\{\rhoalloc,\rhobar,\rhoalloc_m,\rhobarm\},\bar{\tyvar} \extends \bar{\fgjN}, \varphi_m) \spc\spc
C_1 = \{ \tywf{\rhoenv}{\varphi_m} \} \\
\env = \cdot[\thisZ \mapsto B\inang{\bar{\tyvar}}\inang{\rhoalloc\rhobar}][\xbar \mapsto \taubar] \spc\spc
\exprok {\A,\rhoalloc_m,\env}{e} {\tau'} {C_2} \spc\spc
\subtypeok {\A} {\tau'} {\tau} {C_3}
}{
\typeok{} {(B, \tau \; m\inang{\rhoalloc_m\rhobarm \,|\, \varphi_m} (\taubar \;  \xbar)\{\C{return} e;\})} {(C_1 \cup C_2 \cup C_3)}
}

% Original from elaboration algorithm
%$\elabMeth(CT, B, \tau \; m\inang{\rhoalloc_m\rhobarm \,|\, \varphi_m} (\taubar \; \xbar)\{\C{return} e;\})$ = 
%  let $\hdOf{B}{\varphi}\{\bar{\tau^f}\,\xbar;\;\bar{d}\}$ = $CT(B)$ in
%  let ($\rhoenv$,$\aenv$,$\phicx$) as $\A$ = 
%            $(\{\rhoalloc,\rhobar,\rhoalloc_m,\rhobarm\},\bar{\tyvar} \extends \bar{\fgjN},\varphi \conj \varphi_m)$ in
%  let $C_1$ = $\{\tywf{\rhoenv}{\varphi_m}\}$ in
%  let $\env$ = $\cdot[\thisZ \mapsto B\inang{\bar{\tyvar}}\inang{\rhoalloc\rhobar}][\xbar \mapsto \taubar]$ in
%  let ($e':\tau'$,$C_2$) = $\elabExpr (\A,\rhoalloc_m,\env,e)$ in
%  let $C_3$ = $\subtypeOk({\A},{\tau'},{\tau})$ in
%    ($\tau \; m\inang{\rhoalloc_m\rhobarm \,|\, \varphi_m} (\taubar \;
%    \xbar)\{\C{return} e';\}$, $C_1 \cup C_2 \cup C_3$)

% 
% CLASS OK
\lgcrule{CLASS}{
\A = (\rhoenv, \aenv, \phicx) = (\{\rhoalloc,\rhobar\},\bar{\tyvar} \extends \bar{\fgjN},\varphi) \\
C_1 = \{ \tywf{\rhoenv}{\varphi} \} \spc\spc
\typeok {\A} {\fbN} {C_2} \spc\spc
\typeok {\A} {\bar{\tau^f}} {C_3} \\
C_4 = \{\isvalid{\phicx}{\allocRgn(\bar{\tau^f}) \outlives \rhoalloc \conj \allocRgn(\fbN) = \rhoalloc}\} \\
\typeok {} {\bar{d}} {C_6}
}{
\typeok {} {\hdOf{B}{\varphi}\{\bar{\tau^f}\,\xbar;\;\bar{d}\}} {\bigcup_{i=1}^6 C_i}
}

% Original from elaboration algorithm
%  let $\hdOf{B}{\varphi}\{\bar{\tau^f}\,\xbar;\;\bar{d}\}$ = $CT(B)$ in
%  let ($\rhoenv$,$\aenv$,$\phicx$) as $\A$ = $(\{\rhoalloc,\rhobar\},\bar{\tyvar} \extends \bar{\fgjN},\varphi)$ in
%  let $C_1$ = $\tywf{\rhoenv}{\varphi}$ in
%  let ($C_2$,$C_3$) = ($\typeOk({\A},{\fbN})$,$\typeOk({\A},{\bar{\tau^f}})$) in
%  let $C_4$ = $\{\isvalid{\phicx}{\allocRgn(\bar{\tau^f}) \outlives \rhoalloc \conj \allocRgn(\fbN) = \rhoalloc}\}$ in
%  let ($k'$,$C_5$) = $\elabCons(B,k)$ in
%  let ($\bar{d'}$,$C_6$) = $\elabMeth(B,\bar{d})$ in
%    ($\hdOf{B}{\varphi}\{\bar{\tau^f}\,\xbar;\;k'\;\bar{d'}\}$, $\bigcup_{i=1}^6 C_i$)

% \end{mathpar}
\caption{Constraint generation}
\label{fig:constraint-gen}
\end{figure*}
