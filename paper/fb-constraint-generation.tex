% mathpartir's inferrule: seems to have problems with linebreaks
\newcommand{\genconstraint}[2]{\inferrule*{#1}{#2}}
\newcommand{\gcarrow}{\leadsto}
\newcommand{\gctransforms}{\models}

\newcommand{\gcrule}[2]{%
\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
\RULE {#1} {#2}%
\end{array}\end{smathpar}%
}

\newcommand{\minigcrule}[3]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
\RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}

\newcommand{\subtypesym}{<:}

\newcommand{\typeok}[3]{{#1\,\vdash\,#2 \; \texttt{ok} \, \lhd #3}}
\newcommand{\exprok}[4]{{#1} \, \vdash \, {#2} : {#3} \, \lhd {#4}}
\newcommand{\subtypeok}[4]{{#1} \, \vdash \, {#2}  \subtypesym {#3} \, \lhd {#4}} 

\newcommand{\stdcontext}{\exptycx{\ralloc}{\env}}

\begin{figure*}[t]
% \begin{mathpar}

% NEW
  \gcrule
  {
    \typeok {\A} {\fbN} {C_1} \spc
    \exprok {\stdcontext} {\bar{e}} {\bar{\tau'}} {C_2} \spc
    C_3 = \{ \isvalid{\A.\phicx}{\allocRgn(\fbN)=\ralloc} \} \spc
    \fields(\fbN) = \bar{f} : \taubar \spc
    \subtypeok {\A} {\bar{\tau'}} {\bar{\tau}} {C_4}
  }
  {
    \exprok {\stdcontext}   {\C{new} \fbN(\bar{e})} {\fbN} {\cup_{i=1}^4 C_i}
  }

% FUNCTION INVOCATION
\gcrule
{
\exprok {\stdcontext} {e_a} {\inang{\rho_0 \rhobar\,|\,\phi}\taubar \xrightarrow{\rgn} \tau} {C_1} \spc
\exprok {\stdcontext} {\bar{e}} {\bar{\tau'}} {C_2} \spc
\substFn = [\bar{\rho'}/\rhobar][\rho_0'/\rho_0]
\\
C_3 = \{\rho_0' \bar{\rho'} \in \A.\rhoenv\} \spc
C_4 = \{\isvalid{\A.\phicx}{\substFn(\phi)}\} \spc
\subtypeok {\A} {\bar{\tau'}} {\substFn(\bar{tau})} {C_5}
}{
\exprok {\stdcontext} {e_a\inang{\rho_0'\bar{\rho'}}(\bar{e})} {\tau} {\cup_{i=1}^5 C_i}
}

% Original from elaboration algorithm:
% $e_a(\bar{e})$ $\longrightarrow$ 
%    let ($e_a':\inang{\rhoalloc\rhobar\,|\,\phi}\taubar \xrightarrow{\rgn} \tau$,$C_1$) = 
%                $\elabExpr(\A,\ralloc,\env,e_a)$ in
%    let $\bar{\rho'}$ = $\bar{\fresh_\rho()}$ in
%    let $C_2$ = $\{\bar{\rho'} \in \A.\rhoenv\}$ in
%    let $\substFn$ = $[\bar{\rho'}/\rhobar][\ralloc/\rhoalloc]$ in
%    let $C_3$ = $\{\isvalid{\A.\phicx}{\substFn(\phi)}\}$ in
%%*   %let $(C_3,C_4)$ = $(\typeOk(\substFn(\taubar)), \typeOk(\substFn(\tau)))$ in 
%*)   let $(\bar{e'}:\bar{\tau'}, C_4)$ = $\elabExpr(\A,\ralloc,\env,\bar{e})$ in
%    let $C_5$ = $\subtypeOk({\A},{\bar{\tau'}},{\bar{\substFn(\tau)}})$ in
%      ($e_a'\inang{\ralloc\bar{\rho'}}(\bar{e'}):\substFn(\tau)$,$\bigcup_{i=1}^5 C_i$)

% LET-REGION
\gcrule{
\A= (\rhoenv,\aenv,\phicx)  \spc
\rgn \notin \rhoenv \spc
\A' = (\rhoenv \cup \{\rgn\}, \aenv, \phicx \conj (\rhoenv \outlives \rgn))  \spc
\exprok{\A',\rgn,\env} {e_a} {\tau} {C_1} \spc
\typeok {\A} {\tau} {C_2}
}{
\exprok{\stdcontext} {\letregion{\rgn}{e_a}} {\tau} {(C_1 \cup C_2)}
}

% Original from elaboration algorithm:
%  | $\letregion{\rgn}{e_a}$ $\longrightarrow$
%    let $\rgn'$ = $\fresh_{\rgn}()$ in 
%    let $(\rhoenv,\aenv,\phicx)$ = $\A$ in
%    let $\A'$ = ($\rhoenv \cup \{\rgn'\}, \aenv, \phicx \conj (\rhoenv \outlives \rgn')$) in
%    let ($e_a':\tau$,$C_1$) = $\elabExpr(\A',\rgn',\env,[\rgn'/\rgn]e_a)$ in
%      ($\letregion{\rgn'}{e_a'}:\tau$,$C_1$)

\gcrule{
\exprok {\stdcontext} {e_a} {\RgnZ\inang{T}\inang{\rho}} {C_1} \spc
\A = (\rhoenv,\aenv,\phicx) \spc
\rgn \notin \rhoenv \spc
(\A',\env') = ((\rhoenv \cup \{\rgn\},\aenv,\phicx),\env[y\mapsto T@\rgn] \spc
\exprok {\A',\rgn,\env'} {e_b} {\tau} {C_2}
}{
\exprok {\stdcontext} {\open{e_a}{\rgn}{y}{e_b}} {\tau} {C_1 \cup C_2}
}

% Original from elaboration algorithm:
%  | $\open{e_a}{\rgn}{y}{e_b}$ $\longrightarrow$ 
%    let ($e_a':\RgnZ\inang{T}\inang{\rho}$,$C_1$) = 
%                $\elabExpr(\A,\ralloc,\env,e_a)$ in
%    let $\rgn'$ = $\fresh_{\rgn}()$ in 
%    let $(\rhoenv,\aenv,\phicx)$ = $\A$ in
%    let ($\A'$,$\env'$) = ($(\rhoenv \cup \{\rgn'\},\aenv,\phicx)$,$\env[y\mapsto T@\rgn']$) in
%    let ($e_b':\tau$,$C_2$) = $\elabExpr(\A',\rgn',\env',[\rgn'/\rgn]e_a)$ in
%      ($\open{e_a'}{\rgn'}{y}{e_b'} : \tau$, $C_1 \cup C_2$)



% \end{mathpar}
\caption{Constraint generation}
\label{fig:constraint-gen}
\end{figure*}
