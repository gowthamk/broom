\newcommand{\localokin}[2]{#1 \; \texttt{ok} \; \texttt{in} \; #2}

\begin{figure*}[t!]

\beginrules

%%%%%%%%%%% Header Box %%%%%%%%%%%
\multicolumn{2}{l}{
  \textbf{Expression Typing Constraint Generation} \; \fbox{  \( \exprok{\stdcontext}{e}{\tau}{C} \)}
}
\\[0.3cm]

%%%%%%%%%%% () and x %%%%%%%%%%%
\lgcfact{Unit}{\exprok{\stdcontext}{\unitval}{\unitZ}{\{\}}}

\lgcfact{Var}{\exprok{\stdcontext}{x}{\env(\tau)}{\{\}}}

% \begin{minipage}{1.2in}
% \begin{smathpar}
% \begin{array}{l}
% \renewcommand*{\arraystretch}{1.2}
% \exprok{\stdcontext}{\unitval}{\unitZ}{\{\}} \\
% \exprok{\stdcontext}{x}{\env(\tau)}{\{\}}
% \end{array}
% \end{smathpar}
% \end{minipage}

%%%%%%%%%%% FIELD-ACCESS: e.f %%%%%%%%%%%
\lgcrule{FieldAccess}
  {
    \exprok{\stdcontext}{e}{\tau'}{C} \spc
    \bar{f}:\taubar \,=\, \fields(\bound_{\A.\aenv}(\tau'))
  }
  {
    \exprok{\stdcontext}{e.f_i}{\tau_i}{C}
  }

%%%%%%%%%%% LET %%%%%%%%%%%
  \lgcrule{Let}
  {
    \exprok{\stdcontext}{e_1}{\tau_1}{C_1} \spc
    \exprok{\A,{\env[x\mapsto\tau_1]}}{e_2}{\tau_2}{C_2} \\
  }
  {
    \exprok{\stdcontext}{\letexp{x}{e_1}{e_2}}{\tau_2}{C_1 \cup C_2}
  }

%%%%%%%%%%% METHOD-INV %%%%%%%%%%%
  \lgcrule{MethodInv}
  {
    \exprok {\stdcontext} {e_0} {\tau} {C_1} \spc C_2 = \{ \rbar \in \A.\rhoenv \}
    \nl
    \mtype(m,\bound_{\A.\aenv}(\tau)) = \inang{\rhobar \,|\, \phi}\bar{\tau^1}\rightarrow{\tau^2}
    \nl
%   \substFn = [\rbar/\rhobar] \\
    \typeok {\A} {\inang{\rhobar \,|\,\phi}\bar{\tau^1}\rightarrow{\tau^2}} {C_3}
       \spc
       \exprok {\stdcontext} {\bar{e}} {[\rbar/\rhobar](\bar{\tau^1})} {C_4}
    \nl
%   \subtyp{\A}{\bar{\tau'}}{\substFn(\bar{\tau^1})} \spc
    C_5 = \{ \isvalid{\A.\phicx}{[\rbar/\rhobar](\phi)} \}
  }
  {
    \exprok {\stdcontext} {e_0.m\inang{\rbar}(\bar{e})} 
       {[\rbar/\rhobar](\tau^2)} {C_1 \cup C_2 \cup C_3 \cup C_4 \cup C_5}
  }

%%%%%%%%%%% LAMBDA %%%%%%%%%%%

\lgcrule{Lambda}
  {
    \rgn \in \A.\rhoenv \spc
    \rhobar \notin \A.\rhoenv
    \spc
%   \rhoenv' = \rhoenv \cup \{\rhoalloc,\rhobar\}\spc
    \A' = (\A.\rhoenv \cup \{\rhobar\}, \A.\aenv, 
          \A.\phicx \conj \phi)
    \\
    \tywf{\A'.\rhoenv}{\phi}\spc
    \typeok {\A'} {\bar{\tau^1}} {C_1} \spc
    \typeok {\A'} {\tau^2} {C_2}
    \\
    \exprok {\A',\env[\xbar \mapsto \bar{\tau^1}]} {e} {\tau^2} {C_3} \spc
    C_4 = \bigcup\limits_{\pi'\in \frv(e)\setminus\{\rhobar\}}\{\pi'\outlives\pi\}
  }
  {
    \exprok {\stdcontext}
           {\lambdaexp{\rgn}{\rhobar \,|\, \phi} {\xbar:\bar{\tau^1}}{e}}
           {\inang{\rhobar \,|\, \phi} \bar{\tau^1} \xrightarrow{\rgn} \tau^2}
	   {\cup_{i=1}^{4} C_i}
  }


%%%%%%%%%%% SUBTYPING %%%%%%%%%%%
\lgcrule{SubTyping}{
    \exprok {\exptycx{\env}} {e} {\tau} {C_1} \spc  \subtypeok {\A} {\tau} {\tau'} {C_2}
}{
    \exprok {\exptycx{\env}} {e} {\tau'} {C_1 \cup C_2}
}

%%%%%%%%%%% METHOD %%%%%%%%%%%
\multicolumn{2}{l}{
   \textbf{Method Well-formedness Constraint Generation}  \; \fbox{$\okinok{d}{B}{C}$}
}
\\[0.3cm]

\lgcrule{Method}{
CT(B) = \C{class}\; B \angAlpha \inang{\rhobar \,|\, \varphi} \extends \fbN
   \{\bar{\tau^f}\,\xbar;\;\bar{d}\}
\nl
\A = (\rhoenv,\aenv,\phicx) = (\{\rhobar,\rhobarm\}, [\bar{\tyvar} \mapsto \bar{\fgjN}], \varphi_m) \spc\spc
C_1 = \{ \tywf{\rhoenv}{\varphi_m} \}
\nl
\env = \cdot[\thisZ \mapsto B\inang{\bar{\tyvar}}\inang{\rhobar}][\xbar \mapsto \bar{\tau^1}]
\spc
\mtype(m,\fbN) = \inang{\rhobarm \,|\, \phi_m}\bar{\tau^1} \rightarrow \tau^2
\nl
\exprok {\stdcontext}{e} {\tau^2} {C_2}
\spc \typeok {\A} {\bar{\tau^1}} {C_3}
\spc \typeok {\A} {\tau^2} {C_4}
% \subtypeok {\A} {\tau'} {\tau} {C_3}
}{
\okinok {\tau^2 \; m\inang{\rhobarm \,|\, \varphi_m} (\bar{\tau^1} \;  \xbar)\{\C{return} e;\}} {B} {(C_1 \cup C_2 \cup C_3 \cup C_4)}
}

%%%%%%%%%%% CLASS %%%%%%%%%%%
\lgcrule{Class}{
  \A = (\rhoenv, \aenv, \phicx) = (\{\rho,\rhobar\}, [\bar{\tyvar} \mapsto \bar{\fgjN}],\varphi) \\
C_1 = \{ \tywf{\rhoenv}{\varphi} \} \spc\spc
\typeok {\A} {\fbN} {C_2} \spc\spc
\typeok {\A} {\bar{\tau^f}} {C_3} \\
C_4 = \{\isvalid{\phicx}{\allocRgn(\bar{\tau^f}) \outlives \rho \conj \allocRgn(\fbN) = \rho}\} \\
\okinok {\bar{d}} {B} {C_5}
}{
% \typeok {} {\hdOf{B}{\varphi}\{\bar{\tau^f}\,\xbar;\;\bar{d}\}} {\bigcup_{i=1}^5 C_i}
\typeok {}
  {\C{class}\; B\angAlpha \inang{\rho \rhobar \,|\, \varphi} \extends \fbN
      \{\bar{\tau^f}\,\xbar;\;\bar{d}\}}
  {\bigcup_{i=1}^5 C_i}
}


\myendrules

\caption{Constraint generation rules: Part 2}
\label{fig:constraint-gen-1}
\end{figure*}

\begin{figure*}[t!]

\beginrules

%%%%%%%%%%% Header Box %%%%%%%%%%%
\multicolumn{2}{l}{
  \textbf{Type Well-formedness Constraint Generation} \;
  \fbox{  \( \typeok{\A}{\tau}{C} \)}
}
\\[0.3cm]

%%%%%%%%%%% TYPE WELL-FORMEDNESS %%%%%%%%%%%

%%%%%%%%%%% OBJECT TYPE %%%%%%%%%%%
\lgcrule{ObjectType}
  {
    C = \{ \rgn \in \A.\rhoenv \}
  }
  {
    \typeok {\A} {\ObjZ\inang{\rgn}} {C}
  }

%%%%%%%%%%% CLASS TYPE %%%%%%%%%%%
  \lgcrule{ClassType}
  {
    CT(B) = \headerOf{B}\{...\}
    \spc
    \fgjtywf{\aenv}{B\inang{\tbar}}
    \\
    C = \{ \rbar \in \rhoenv, \isvalid{\phicx}{[\rbar/\rhobar](\phi)} \}
  }
  {
    \typeok {(\rhoenv,\aenv,\phicx)} {B\inang{\rbar}\inang{\tbar}} {C}
  }

%%%%%%%%%%% GENERIC TYPE PARAMETER %%%%%%%%%%%
  \lgcrule{TypeParam}
  {
    \fgjtywf{\A.\aenv}{T} \spc
    \fgjsubtyp{\A.\aenv}{T}{\ObjZ} \spc
    \spc
    C = \{ \rgn \in \A.\rhoenv \}
  }
  {
    \typeok {\A}{T@\rgn} {C}
  }

%%%%%%%%%%% FUNCTION TYPE %%%%%%%%%%%
  \lgcrule{FnType}
  {
    C_1 = \{ \rgn \in \rhoenv \}
    \\
    \rhobar \notin \A.\rhoenv \spc
    \rhoenv' = \rhoenv \cup \{\rhobar\} \spc
    \A' = (\rhoenv', \aenv, \phicx \conj \phi)
    \\
    \tywf{\rhoenv'}{\phi}\spc 
    \typeok{\A'}{\bar{\tau^1}} {C_2} \spc
    \typeok{\A'}{\tau^2} {C_3}
  }
  {
    \typeok{(\rhoenv,\aenv,\phicx)} {\inang{\rhobar \,|\, \phi} \bar{\tau^1} \xrightarrow{\rgn} \tau^2} 
       {C_1 \cup C_2 \cup C_3}
  }

%%%%%%%%%%% REGION TYPE %%%%%%%%%%%
  \lgcrule{RegionType}
  { 
    \fgjtywf{\A.\aenv}{T}
  }
  {
    \typeok {\A} {\RgnZ\inang{T}\inang{\toprgn}} {\{\}}
  }

%%%%%%%%%%% Header Box %%%%%%%%%%%
\multicolumn{2}{l}{
  \textbf{Subtyping Constraint Generation} \;
\fbox{  \( \subtypeok{\A}{\tau_1}{\tau_2}{C} \)}
}
\\[0.3cm]

%%%%%%%%%%% SUBTYPING: REFLEXIVE %%%%%%%%%%%

  \lgcfact{Reflexivity}{
    \subtypeok{\A}{\tau}{\tau}{\{\}}
  }

%%%%%%%%%%% SUBTYPING: UNIFICATION %%%%%%%%%%%
  \lgcfact{Unify}{
    \subtypeok{\A}{\tau}{[\pi/\rho](\tau)}{ \{ \pi \outlives \rho, \rho \outlives \pi \} }
  }

%%%%%%%%%%% SUBTYPING: TRANSITIVITY %%%%%%%%%%%

  \lgcrule{Transitivity}{
    \subtypeok{\A}{\tau_1}{\tau_2}{C_1} \spc
    \subtypeok{\A}{\tau_2}{\tau_3}{C_2}
  }{
    \subtypeok{\A}{\tau_1}{\tau_3}{C_1 \cup C_2}
  }

%%%%%%%%%%% FUNCTION SUBTYPING %%%%%%%%%%%
  \lgcrule{FnSubtyping}
  {
    C_1 = \{ \isvalid{\A.\phicx}{\phi_1 \Rightarrow \phi_2} \}
    \\
    \subtypeok {\A} {\bar{\tau^{11}}} {\bar{\tau^{21}}} {C_2}
    \spc
    \subtypeok {\A} {\tau^{22}} {\tau^{12}} {C_3}
  }
  {
    \subtypeok {\A}
      {\inang{\rhobar \,|\, \phi_2}\bar{\tau^{21}} \xrightarrow{\rgn} \tau^{22}}
      {\inang{\rhobar \,|\, \phi_1}\bar{\tau^{11}} \xrightarrow{\rgn} \tau^{12}}
      {C_1 \cup C_2 \cup C_3}
  }

\myendrules

\caption{Constraint generation rules: Part 3}
\label{fig:constraint-gen-2}
\end{figure*}
