\begin{theorem}
\emph{(\textbf{Preservation})}
\label{thm:fb-preservation}
$\forall e, \tau, \rhoenv, \rhomap, \phicx$, such that $\frv(e)
\subseteq dom(\rhomap)$ and $\tywf{\rhoenv}{\phicx}$ and
$\hastyp{\emptyA, \cdot}{e}{\tau}$, if
$\redstoo{(e,\rhomap)}{(e',\rhomap')}$, then:
  \begin{smathpar}
  \begin{array}{rl}
    (i) & \hastyp{\emptyASigp, \cdot}{e'}{\tau}\\
    (ii) & \frv(e') \subseteq dom(\rhomap') \\
  \end{array}
  \end{smathpar}
\end{theorem}
\begin{proof}
Intros $e$. Induction on $e$. For every subexpressions $e_0$, inductive
hypothesis gives us the following:
\begin{smathpar}
\begin{array}{cr}
  \forall (\tau_0, \rhoenv_0, \rhomap_0, \phicx_0, \rgn_0). \spc 
  (\frv(e_0) \subseteq dom(\rhomap_0)) \conj
  (\tywf{\rhoenv_0}{\phicx_0}) \conj
  (\hastyp{(\rhoenv_0,\cdot,\phicx_0), \cdot}{e_0}{\tau_0}) \conj 
  (\redstoo{(e_0,\rhomap_0)} {(e_0',\rhomap_0')}) & IH1\\
     \Rightarrow \hastyp{(\rhoenv_0,\cdot,\phicx_0), \cdot}{e_0'}{\tau_0} 
      ~\conj~ \frv(e_0') \subseteq dom(\rhomap_0')& \\
\end{array}
\end{smathpar}
Cases from induction
\begin{itemize}
\item Case ($e = \unitval$ or $e = x$): Proof is trivial.
\item Case ($e = e_0.f_i$): Intros. Hypothesis:
  \begin{smathpar}
  \begin{array}{cr}
    \tywf{\Delta}{\phicx} & H1\\
    \frv(e)\subseteq dom(\rhomap) & H2\\
    \hastyp{\emptyA, \cdot}{e}{\tau} & H4\\
    \redstoo{(e,\rhomap)}{(e',\rhomap')} & H6\\
  \end{array}
  \end{smathpar}
  Since $e_0$ is a subexpression of $e$, $H2$ implies:
  \begin{smathpar}
  \begin{array}{cr}
    \frv(e_0)\subseteq dom(\rhomap) & H3\\
  \end{array}
  \end{smathpar}
  Inverting $H4$:
  \begin{smathpar}
  \begin{array}{cr}
    \hastyp{\emptyA, \cdot}{e_0}{\tau'} & H7\\
    \bar{f} :\taubar = \fields(\bound_{\cdot}(\tau')) & H9\\
  \end{array}
  \end{smathpar}
  Inverting $H6$, we get two cases:
  \begin{itemize}
    \item SCase ($\redstoo{(e_0,\rhomap)}{(e_0',\rhomap')}$): In this
    case, $\redstoo{(e_0.f_i,\rhomap)}{(e_0'.f_i,\rhomap')}$.
    Applying $IH1$ with $H1$, $H3$ and $H7$ gives:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyASigp, \cdot}{e_0'}{\tau'} & H11\\
      \frv(e_0') \subseteq dom(\rhomap') & H12\\
    \end{array}
    \end{smathpar}
    $H11$ and $H9$ tell us that $\hastyp{\emptyASigp,
    \cdot}{e_0'.f_i}{\tau_i}$. $H12$ gives $\frv(e_0'.f_i) \subseteq
    dom(\rhomap')$. 

    \item SCase ($e_0$ is a value $\C{new} \; \fbN(\vbar)$, where
    $\fbN \neq \RgnZT{\rgn}$): Hypotheses:
    \begin{smathpar}
    \begin{array}{cr}
      \allocRgn(N) \in \rhoenv & H13\\
      \redstoo{(e,\rhomap)}{(v_i,\rhomap)} & H15\\
    \end{array}
    \end{smathpar}
    \end{itemize}
    We need to prove that $\hastyp{(\emptyA,\cdot)}{v_i}{\tau_i}$. 
    From $H7$, since $e_0 = \C{new} \; \fbN(\vbar)$:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyA, \cdot}{\C{new} \;\fbN(\vbar)}{\tau'} & H16\\
    \end{array}
    \end{smathpar}
    Inverting $H16$ and using $H9$ gives us the proof.

  \item Case ($e = \letregion{\rgn_0}{e_0}$): Intros. Hypothesis:
  \begin{smathpar}
  \begin{array}{cr}
    \tywf{\Delta}{\phicx} & H1\\
    \frv(e)\subseteq dom(\rhomap) & H2\\
    \hastyp{\emptyA, \cdot}{e}{\tau} & H4\\
    \redstoo{(e,\rhomap)}{(e',\rhomap')} & H6\\
  \end{array}
  \end{smathpar}
  From the definition of $\frv$ and $H2$
  \begin{smathpar}
  \begin{array}{cr}
    \frv(e_0) \subseteq dom(\rhomap) & H3\\ 
  \end{array}
  \end{smathpar}
  Inverting $H4$:
  \begin{smathpar}
  \begin{array}{cr}
    \rgn_0 \notin \rhoenv & H7\\
    \tywf{\emptyA}{\tau} & H8\\
    \hastyp{\emptyADelcupPhicap{\rgn_0}{\rgn_0}, \cdot}{e_0}{\tau} & H9\\
  \end{array}
  \end{smathpar}
  Inverting $H6$, we get two cases:
  \begin{itemize}
    \item SCase ($\redstocup{\rgn_0}{(e_0,\rhomap)}{(e_0',\rhomap')}$): In this
    case, $\redstoo{(\letregion{\rgn_0}{e_0},\rhomap)}
    {(\letregion{\rgn_0}{e_0'},\rhomap')}$ (i.e., $e'$ is $\letregion{\rgn_0}{e_0'}$).
    Applying $IH1$ using $H1$, $H3$ and $H9$ gives:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyADelcupPhicap{\rgn_0}{\rgn_0},
          \cdot}{e_0'}{\tau} & H11\\
    \frv(e_0') \subseteq dom(\rhomap') & H12\\ 
    \end{array}
    \end{smathpar}
    From $H7$ and $H11$, we can conclude that
    $\hastyp{\emptyASigp, \cdot}{\letregion{\rgn_0}{e_0'}}{\tau}$.
    Furthermore, since $\frv(e') = \frv(e_0')$, from $H12$, we have
    $\frv(e') \subseteq dom(\rhomap')$.

    \item SCase ($e_0$ is a value $v_0$): In this case,
    $\redstoo{(\letregion{\rgn_0}{e_0},\rhomap)} {(v_0,\rhomap')}$
    (i.e., $e'$ is $v_0$). $H1$ and $H7$ imply:
    \begin{smathpar}
    \begin{array}{cr}
      \tywf{\rhoenv \cup \{\rgn_0\}}{\phicx} & H10\\
    \end{array}
    \end{smathpar}
    Applying $IH1$ with $H9$ $H1$ and $H10$ gives:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyADelcupPhicap{\rgn_0}{\rgn_0},
          \cdot}{v_0}{\tau} & H13\\
       \frv(v_0) \subseteq dom(\Sigma') & H14\\
    \end{array}
    \end{smathpar}
    From $H13$, $H8$ and Lemma~\ref{thm:fb-tywf}, we have:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyA, \rgn, \cdot}{v_0}{\tau} & H15\\
    \end{array}
    \end{smathpar}
    $H14-15$ give the proof.
  \end{itemize}

  \item Case ($e = \open{e_a}{\rgn_0}{y}{e_b}$): Intros. Hypotheses:
  \begin{smathpar}
  \begin{array}{cr}
    \tywf{\Delta}{\phicx} & H1\\
    \frv(e)\subseteq dom(\rhomap) & H2\\
    \hastyp{\emptyA, \cdot}{e}{\tau} & H4\\
    \redstoo{(e,\rhomap)}{(e',\rhomap')} & H6\\
%   \forall (\tau, \rhoenv, \rhomap, \rgn). \rgn \in \rhoenv \conj
%     \hastyp{\emptyA, \cdot}{e_0}{\tau} \;
%     \Rightarrow \; \exists(e',\rhomap'). \redstoo{(e_0,\rhomap)}
%                     {(e',\rhomap')} & IH1\\
  \end{array}
  \end{smathpar}
  $H2$ implies:
  \begin{smathpar}
  \begin{array}{cr}
    \frv(e_a)\subseteq dom(\rhomap) & H3\\
    \frv(e_b)\subseteq dom(\rhomap) & H5\\
  \end{array}
  \end{smathpar}
  Inverting $H4$:
  \begin{smathpar}
  \begin{array}{cr}
    \hastyp{\emptyA, \cdot}{e_a}{\RgnZ\inang{T}\inang{\toprgn}} & H7\\
    \tywf{\emptyA}{\tau} & H8\\
    \rgn_0 \notin \rhoenv & H9\\
    \hastyp{\emptyASigpDelcup{\rgn_0},[y \mapsto T@\rgn_0]}{e_b}{\tau} & H11\\
  \end{array}
  \end{smathpar}
  Inverting $H6$, we get many cases:
  \begin{itemize}
    \item SCase ($\redstoo{(e_a,\rhomap)}{(e_a',\rhomap')}$): Proof
    follows from $IH1$.

    \item SCase ($e_a$ is a value $v_a$, and $e_b$ steps to $e_b'$):
    Since $e_a$ is a value $v_a$, inverting $H7$ tells us that there
    exist a value $v_r$ and a region identifier $\rgn_i$ s.t:
    \begin{smathpar}
    \begin{array}{cr}
%       \rgn_i \in dom(\Sigma) & H13\\
        \hastyp{(\{\rgn_i\}, \cdot, true), \cdot}{v_r}{T@\rgn_i} & H15\\
        v_a = \C{new}\; \RgnZ\inang{T}\inang{\rgn_i}(v_r) & H22\\
    \end{array}
    \end{smathpar}
    Changing the region variable name in $H15$:
    \begin{smathpar}
    \begin{array}{cr}
        \hastyp{(\{\rgn_0\}, \cdot, true), \cdot}{[\rgn_0/\rgn_i]
        v_r}{T@\rgn_0} & H17\\
    \end{array}
    \end{smathpar}
    From $H9$, $H1$ and $H17$:
    \begin{smathpar}
    \begin{array}{cr}
        \hastyp{(\Delta \cup \{\rgn_0\}, \cdot, \phicx),
        \cdot}{[\rgn_0/\rgn_i] v_r}{T@\rgn_0} & H19\\
    \end{array}
    \end{smathpar}
    From $H11$, $H19$ and the substitution lemma
    (Lemma~\ref{thm:fb-substitution}):
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyASigpDelcup{\rgn_0},\cdot}{[[\rgn_0/\rgn_i]v_r/y]\,e_b}{\tau}
      & H20\\
    \end{array}
    \end{smathpar}
    Since $e_b$ takes a step, from \rulelabel{OPEN} rule of
    operational semantics, we get the following hypotheses:
    \begin{smathpar}
    \begin{array}{cr}
      \rhomap(\rgn_i) \neq \XFERRED & H24\\
      \redstocup{\rgn_0}{([[\rgn_0/\rgn_i]v_r/y]e_b,
          \rhomap[\rgn_i \mapsto \OPEN])} {(e_b',\rhomap')} & H27\\
%     \rhomap'' = \rhomap'[\rgn_i \mapsto \rhomap(\rgn_i)] & H29\\
    \end{array}
    \end{smathpar}
    Applying $IH1$ using $H1$, ($H5$, $H17$) and $H27$, we get: 
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyASigpDelcup{\rgn_0},\cdot}{e_b'}{\tau} & H29\\
      \frv(e_b') \subseteq dom(\Sigma') & H30\\
    \end{array}
    \end{smathpar}
    From $H29$, extending the type environment:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyASigpDelcup{\rgn_0},[y\mapsto T@\rgn_0]}{e_b'}{\tau} & H31\\
    \end{array}
    \end{smathpar}
    $H7-H9$ and $H29$ proves $\hastyp{\emptyASigpp,\cdot}{\open{v_a}{\rgn_0}{y}{ e_b'}}{\tau}$. 
    It can be easily shown that $dom(\Sigma) \subseteq dom(\Sigma')$.
    Hence, $H3$ (and the fact that $e_a = v_a$) implies $\frv(v_a)
    \subseteq dom(\Sigma')$. This lets us prove that $\frv(e')
    \subseteq dom( \Sigma')$.
    
    \item SCase ($e_a$ is a value $v_a$, and $e_b$ is a value $v_b$): In this
    case, $\redstoo{(\open{v_a}{\rgn_0}{y}{v_b},\rhomap)} {(v_b,\rhomap)}$. 
    From $H11$:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyADelcup{\rgn_0} , [y \mapsto T@\rgn_0]}{v_b}{\tau} & H53\\
    \end{array}
    \end{smathpar}
    Since $\valuee(v_b)$, it has not free variables. Consequently:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyADelcup{\rgn_0} ,
        \cdot}{v_b}{\tau} & H55\\
    \end{array}
    \end{smathpar}
%   Since $dom(\rhomap) \subseteq dom(\rhomap')$:
%   \begin{smathpar}
%   \begin{array}{cr}
%     \hastyp{(dom(\rhomap'),\rhoenv \cup \{\rgn_0\},\cdot,true),
%       \cdot}{v_b}{\tau} & H57\\
%   \end{array}
%   \end{smathpar}
    Since $\tau$ is well-formed under $\emptyA$ ($H8$), Applying
    Lemma~\ref{thm:fb-tywf} using $H8$ gives: required goal:
    \begin{smathpar}
    \begin{array}{cr}
      \hastyp{\emptyA, \cdot}{v_b}{\tau} & \\
    \end{array}
    \end{smathpar}
    From the hypothesis, we have $\frv(e) = \frv(v_a) \cup \frv(v_b)
    \subseteq dom(\Sigma)$. Hence, $\frv(e') = \frv(v_b) \subseteq
    dom(\Sigma)$.
  % End of cases for open   
  \end{itemize}

  \item Case ($e = \C{new}\; \RgnZT{\toprgn}(e_0)$): 
% Preservation follows trivially from the $IH$ when $e_0$ takes a step. The non-trivial case is when
% $e_0$ is a value $v_0$. 
  Hypotheses:
  \begin{smathpar}
  \begin{array}{cr}
    \tywf{\Delta}{\phicx} & H1\\
    \frv(e_0)\subseteq dom(\rhomap) & H2\\
    \hastyp{\emptyA, \cdot}{\C{new}\; \RgnZT{\toprgn}(e_0)}{\tau} & H4\\
    \redstoo{(e,\rhomap)}{(e',\rhomap')} & H6\\
  \end{array}
  \end{smathpar}
  Inverting $H4$, we know that $e_0 = \lambdaexp{\rgn}{\rho}{}{e_1}$, and:
  \begin{smathpar}
  \begin{array}{cr}
    \hastyp{\vacantA{\rho},\cdot}{e_1} {T@\rho}& H7\\
%   \hastyp{\emptyA, \cdot}{v_0}{\inang{\rho}\unitZ
%       \xrightarrow{\rgn} T@\rho} & H7\\
    \fgjtywf{\cdot}{T} & H8\\
%   \rgn_0 \notin \rhoenv & H9\\
%   \hastyp{(dom(\rhomap),\rhoenv \cup \{\rgn_0\},\cdot,true),[y \mapsto
%   T@\rgn_0]}{e_b}{\tau} & H11\\
  \end{array}
  \end{smathpar}
% Inverting $H7$, we know that $v_0 = \lambdaexp{\rgn}{\rho}{}{e_1}$, and
% we get the following hypotheses:
% \begin{smathpar}
% \begin{array}{cr}
%   \rho \notin \rhoenv & H13\\
%   \hastyp{\emptyADelcup{\rho},\rho,\cdot}{e}{T@\rho} & H15\\
% \end{array}
% \end{smathpar}
  Inverting $H6$:
  \begin{smathpar}
  \begin{array}{cr}
    \rgn_i \notin dom(\rhomap) \cup \rhoenv & H17\\
    \rhomap' = \rhomap[\rgn_i \mapsto \CLOSED] & H19\\
    \redstoo{(\C{new}\; \RgnZT{\toprgn}(\lambdaexp{\rgn}{\rho}{}{e_1}))}
      {(\C{new}\; \RgnZT{\rgn_i}([\rgn_i/\rho]e_1),\rhomap')} & H21\\
  \end{array}
  \end{smathpar}
  Renaming the region var in $H7$:
  \begin{smathpar}
  \begin{array}{cr}
    \hastyp{\vacantA{\rgn_i},\rgn_i,\cdot}{[\rgn_i/\rho]e_1} {T@\rgn_i}& H10\\
  \end{array}
  \end{smathpar}
  Since $\rgn_i \notin \Delta$ (from $H17$), it is safe to strengthen
  the context of the type judgment in $H10$ to the following:
  \begin{smathpar}
  \begin{array}{cr}
    \hastyp{\emptyASigpDelcup{\rgn_i},\rgn_i,\cdot}{[\rgn_i/\rho]e}
        {T@\rgn_i} & H24\\
  \end{array}
  \end{smathpar}
% From $H13$, $H17$, $H15$ and Lemma~\ref{thm:fb-renaming}, we get:
% \begin{smathpar}
% \begin{array}{cr}
%   \hastyp{\emptyADelcup{\rgn_i},\rgn_i,\cdot}{[\rgn_i/\rho]e}
%       {T@\rgn_i} & H23\\
% \end{array}
% \end{smathpar}
% Since $dom(\rhomap) \subseteq dom(\rhomap')$, $H23$ is equivalent to:
% \begin{smathpar}
% \begin{array}{cr}
%   \hastyp{\emptyASigpDelcup{\rgn_i},\rgn_i,\cdot}{[\rgn_i/\rho]e}
%       {T@\rgn_i} & H24\\
% \end{array}
% \end{smathpar}
  $H19$ implies $\rgn_i \in dom(\rhomap')$. This, and $H17$, $H8$, and
  $H24$ entail type preservation:
  \begin{smathpar}
  \begin{array}{cr}
    \hastyp{\emptyASigp, \cdot}{\C{new}\; \RgnZT{\rgn_i}
        ([\rgn_i/\rho]e_1)}{\RgnZT{\toprgn}} & \\
  \end{array}
  \end{smathpar}
  $\frv(e') = \{\rgn_i\} \cup \frv([\rgn_i/\rho]e_1)$. We need to
  prove that $\frv(e') \subseteq dom(\Sigma') = \{\rgn_i\} \cup
  dom(\Sigma)$.  From initial hypotheses ($H2$), we know that $\frv(e)
  = \frv(e_0) = \frv(e_1) \subseteq dom(\Sigma)$. Since $\rgn_i \in
  dom(\Sigma')$, we have that $\frv([\rgn_i/\rho]e_1) \subseteq
  dom(\Sigma')$.  

  \item Case ($e = \C{new} \RgnZT{\rgn_i}(e_0)$, where $\rgn_i \neq \toprgn$):Hypotheses:
  \begin{smathpar}
  \begin{array}{cr}
    \tywf{\Delta}{\phicx} & H1\\
    \{\rgn_i\} \cup \frv(e_0)\subseteq dom(\rhomap) & H2\\
    \hastyp{\emptyA, \cdot}{\C{new}\; \RgnZT{\rgn_i}(e_0)}{\tau} & H4\\
    \redstoo{(\C{new} \RgnZT{\rgn_i}(e_0),\rhomap)}{(e',\rhomap')} & H6\\
  \end{array}
  \end{smathpar}
  Since $e$ isn't a value,  inverting $H6$ tells us that $\C{new}
  \RgnZT{\rgn_i}(e_0)$ takes a step to $\C{new} \RgnZT{\rgn_i}(e_0')$ when $e_0$
  takes a step to $e_0'$.  The proof for this case is similar to the previous
  case; we invert $H4$ and $H6$, apply inductive hypothesis to derive typing
  judgment for $e_0$ under a context containing $\rgn_i$, and finally apply the
  type rule for $\C{new} \RgnZT{\rgn_i}(e_0')$ (where $\rgn_i
  \neq \toprgn$) to prove the preservation.

  \item Case ($e$ is a lambda expression): $e$ is a value, hence cannot take a
  step.

  \item Case ($e$ is a method/function call, or a \C{let} expression): Proof
  follows directly from the inductive hypothesis, and substitution lemma
  (\ref{thm:fb-substitution}).

%End of cases for proof
\end{itemize}

\qed
\end{proof}

