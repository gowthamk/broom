%%%%%%%%%%%%%%%%%%%%%%% WF RULES %%%%%%%%%%%%%%%%%%%%%%%%%%%
\textbf{Type Well-formedness}  \; \fbox {\(\tywf{\A}{\tau} \)}\\
%
\begin{minipage}{2.55in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    CT(B) = \headerOf{B}\{...\}\\
    \rbar \in \rhoenv \spc
%   \mem(\rbar) = \overline{\LIVE} \spc
    \fgjtywf{\aenv}{B\inang{\tbar}}\spc
%   \substFn = [\rbar/\rhobar, \tbar/\bar{\tyvar}] \spc
    \isvalid{\phicx}{[\rbar/\rhobar](\phi)}
  }
  {
    \tywf{(\rhoenv,\aenv,\phicx)}{B\inang{\tbar}\inang{\rbar}}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{1.25in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \fgjtywf{\aenv}{T}\spc
%   \rgn \in \A.\rhoenv\\
    \rgn \in \rhoenv\\
    \fgjsubtyp{\aenv}{T}{\ObjZ}\spc
  }
  {
    \tywf{(\rhoenv,\aenv,\phicx)}{T@\rgn}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{0.9in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  { 
    \\
    \A = (\subtypcx) \spc
    \fgjtywf{\aenv}{T}
  }
  {
    \tywf{\A}{\RgnZ\inang{T}\inang{\toprgn}}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

\bigskip
%%%%%%%%%%%%%%%%%%%%%%%% TYPE RULES %%%%%%%%%%%%%%%%%%%%%%%%%%%
\textbf{Expression Typing}  \; \fbox
  {\(\hastyp{\exptycx{\env}{\rgn}}{e}{\tau} \)}\\
%
\begin{minipage}{2.2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \hastyp{\exptycx{\env}{\rgn}}{\bar{e}}{\taubar} \\
    \tywf{\A}{\fbN} \spc
    \fields(\fbN) = \bar{f} : \taubar \\
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}{\C{new}\; \fbN(\bar{e})}{\fbN}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
%   We don't need the following condition because of the
%   guarantee provided by the lambda type rule.
%   \A = (\subtypcx) \spc
%   \rgn \in \rhoenv \\
    \\
    \hastyp{\exptycx{\env}{\rgn}}{e} {\inang{\rho} \unitZ \xrightarrow{\rgn} T@\rho} \spc
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}{\C{new}\;
    \RgnZ\inang{T}\inang{\toprgn}(e)} {\RgnZ\inang{T}\inang{\toprgn}}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\begin{minipage}{2.2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \hastyp{\exptycx{\env}{\rgn}}{e}{\tau'}\\
    \bar{f}:\taubar \,=\, \fields(\bound_{\A.\aenv}(\tau'))
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}{e.f_i}{\tau_i}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{2.9in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \A = (\subtypcx) \spc
    \A' = (\rhoenv\cup\{\pi\}, \aenv, \phicx \conj \phi)\\
    \pi \notin \rhoenv \spc
%   \Delta = \{\rgn \,|\, \rgn \in \rhoenv\} \spc
    \phi = \Delta \outlives \pi \spc
    \hastyp{\A',\env,\pi}{e}{\tau} \spc
    \tywf{\A}{\tau}
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}{\letregion{\pi}{e}}{\tau}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\begin{minipage}{2.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \A = (\subtypcx) \spc
    \pi \notin \rhoenv \\
    \hastyp{\exptycx{\env}{\rgn}}{e_a}
            {\RgnZ\inang{T}\inang{\toprgn}}\\
%   \rgn \notin dom(\mem) \spc
    \tywf{\A}{\tau} \spc
    \A' = (\rhoenv\cup\{\pi\},\aenv,\phicx) \\
    \env' =  \env[y\mapsto T@\pi]\spc
    \hastyp{\A',\env',\pi}{e_b}{\tau} \spc
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}{\open{e_a}{\pi}{y}{e_b}}
            {\tau}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{2.6in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \A = (\subtypcx) \spc
    \rgn \in \rhoenv \spc
    \rhoenv \outlives \rgn \\
    \rho,\rhobar \notin \rhoenv \spc
    \A' = (\rhoenv \cup \{\rho,\rhobar\}, \aenv, 
          \phicx \conj \phi)\\
    \tywf{\rhoenv \cup \{\rho,\rhobar\}}{\phi}\spc
    \tywf{\A'}{\bar{\tau^1}}\\
    \tywf{\A'}{\tau^2}\spc
    \hastyp{\A',\env[\xbar \mapsto \bar{\tau^1}],\rho}{e}{\tau^2}
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}
           {\lambdaexp{\rgn}{\rho\rhobar \,|\, \phi}
                      {\xbar:\bar{\tau^1}}{e}}
           {\inang{\rho\rhobar \,|\, \phi}
            \bar{\tau^1} \xrightarrow{\rgn} \tau^2}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\begin{minipage}{2.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \A = (\subtypcx) \spc
    \hastyp{\exptycx{\env}{\rgn}}{e_0}{\tau} \\
%   \rbar \in \A.\rhoenv \\
    \mtype(m,\bound_{\aenv}(\tau)) = \inang{\rho\rhobar \,|\, 
        \phi}\bar{\tau^1}\rightarrow{\tau^2} \\
    \rgn,\rbar \in \rhoenv \spc
    \tywf{\A}{\inang{\rho\rhobar \,|\,
    \phi}\bar{\tau^1}\rightarrow{\tau^2}}\\
    \hastyp{\exptycx{\env}{\rgn}}{\bar{e}}{[\rgn\rbar/\rho\rhobar]\,\bar{\tau^1}} \spc
    \isvalid{\phicx}{[\rgn\rbar/\rho\rhobar]\,\phi}
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}{e_0.m\inang{\rgn\rbar}(\bar{e})} 
           {[\rgn\rbar/\rho\rhobar]\,\tau^2}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{2.3in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \\
    \A = (\subtypcx) \spc
    \rgn',\rgn,\rbar \in \rhoenv \\
    \hastyp{\exptycx{\env}{\rgn}}{e}
        {\inang{\rho\rhobar \,|\, \phi}
            \bar{\tau^1} \xrightarrow{\rgn'} \tau^2}\\
%   \substFn = \subst{\rbar}{\rhobar} \spc
    \isvalid{\phicx}{\subst{\rgn\rbar}{\rho\rhobar}\phi} \spc
    \hastyp{\exptycx{\env}{\rgn}}{\bar{e}}
        {\subst{\rgn\rbar}{\rho\rhobar}\bar{\tau^1}}\spc
%   \subtyp{\A}{\taubar}{\bar{\tau^1}}
  }
  {
    \hastyp{\A,\env,\rgn}{e\inang{\rgn\rbar}(\bar{e})}
           {\subst{\rgn\rbar}{\rho\rhobar}\tau^2}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\bigskip

%%%%%%%%%%%%%%%%%%%%% METHOD WF %%%%%%%%%%%%%%%%%%%%%%%
\textbf{Method Well-formedness}  \; \fbox
  {\(d \; \mathtt{ok \; in} \; B \)}\\
%
\begin{minipage}{5.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
%   \rhoenv = \{\rhobar,\bar{\rho_m}\} \spc
%   \aenv = [\bar{\tyvar} \mapsto \bar{\fgjN}] \spc
%   \phicx = \phi \conj \phi_m \spc
    \Delta = \{\rhobar,\rho_m, \bar{\rho_m}\} \spc
    \A = (\Delta, [\bar{\tyvar} \mapsto \bar{\fgjN}], \phi_m)\spc
    \tywf{\Delta}{\phi_m} \\
    \tywf{\A}{\bar{\tau^1},\tau^2} \spc
%   \tywf{\A}{\tau^2} \spc
    CT(B) = \headerOf{B}\{...\}\\
    \env = \cdot[\xbar\mapsto\bar{\tau^1}][\thisZ\mapsto
            B\inang{\bar{\tyvar}}\inang{\rhobar}] \spc
    \A \vdash \override(m,\fbN,\inang{\rho_m\rhobarm \,|\, \phi_m}\bar{\tau^1} 
             \rightarrow \tau^2) \spc
%   \stmtsem{\rhoallocm}{s}{\stmtsemcx}{\stmtsemcxp}\spc
    \hastyp{\exptycx{\env}{\rho_m}}{e}{\tau^2} \spc
%   \subtyp{\A}{\tau}{\tau^2}
  }
  {
    \okin 
        {\tau^2 \; m\inang{\rho_m\rhobarm \,|\, \phi_m}
              (\bar{\tau^1}\;\xbar)\{\C{return}\,e;\}}
        {B}
  }
\end{array}
\end{smathpar}
\end{minipage}
%


