\newcommand{\opsemrule}[3]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
\RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}
\newcommand{\lopsemrule}[4]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
[\rulelabel{#4}] \spc \RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}
%
\newcommand{\anobjty}[0]{B\inang{\tbar}\inang{\ralloc\rbar}}
\newcommand{\anobj}[0]{\C{new} \; \anobjty(\bar{v})}
%

\begin{figure*}[t!]

%
\fbox {\(\redstoo{(e,\rhomap)}{(e',\rhomap')}\)}\\

\lopsemrule{1.5in}{
    \redstoo{(e,\rhomap)}{(e',\rhomap')}
}{
    \redstoo{(E\lbrack e \rbrack, \rhomap)}
            {(E\lbrack e' \rbrack, \rhomap')}
	  }{EVAL-ORDER}

\lopsemrule{1.2in}{
    \redstoo{(e,\rhomap)}{\invalidexn}
  }{
    \redstoo{(E\lbrack e \rbrack, \rhomap)}
            {\invalidexn}
	  }{EXCEPTION}
%

\lopsemrule{2.7in}{
    \allocRgn(\fbN) \in \rhoenv \spc
    \fields(\fbN) = \bar{f}:\taubar
}{
    \redstoo{((\C{new} \; \fbN(\vbar)).f_i,\rhomap)}{(v_i,\rhomap)}
}{FIELD-ACCESS}

\lopsemrule{3.85in}{
    \allocRgn(\fbN),\ralloc \in \rhoenv \spc
    \mbody(m\inang{\ralloc \rbar},\fbN) = \bar{x}.e 
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
}{
    \redstoo{((\C{new}\;\fbN(\bar{v})).m\inang{\ralloc \rbar}
                      (\bar{v'}),\rhomap)}
            {([\bar{v'}/\xbar][\C{new} \; \fbN(\bar{v})/\thisZ]\,e,\rhomap)}
	  }{METHOD-INV}

\lopsemrule{2.85in}{
    v_a = \lambdaexp{\rgn_a}{\rhoalloc\rhobar}
                        {\taubar \; \xbar}{e} \spc
    \rgn_a,\ralloc \in \rhoenv \spc 
}{
    \redstoo{(v_a\inang{\ralloc\rbar}(\bar{v}) ,\rhomap)}
            {([\bar{v}/\xbar][\rbar/\rhobar][\ralloc/\rhoalloc]\,e,\rhomap)}
	  }{FUN-APPLY}

%
\lopsemrule{2in}{
%   \rgn \notin \rhoenv \spc
%   \fresh(\rgn') \spc
    \redsto{\rhoenv \cup \{\rgn\}}{(e,\rhomap)}{\invalidexn}
}{
    \redstoo{(\letregion{\rgn}{e},\rhomap)}{\invalidexn}
  }{EXCEPTION}

\lopsemrule{2in}{
%   \fgjN = \RgnZ\inang{T} \spc
%   \rgn \in dom(\rhomap) \spc
    \redsto{\Delta \cup \{\rgn\}}{(e,\rhomap)}{\invalidexn}
}{
    \redstoo{(\C{new} \; \fgjN\inang{\rgn}
                (e),\rhomap)}
            {\invalidexn}
	  }{EXCEPTION}

\lopsemrule{2.5in}{
    \rhomap(\rgn_r) \neq \XFERRED \spc
%   \fresh(\rgn_1) \spc
%  \rgn_0 \notin \rhoenv \\
    \redsto{\Delta \cup \{\rgn\}}{([v_r/x]e_b,
      \rhomap[\rgn_r \mapsto \OPEN])}{\invalidexn}
}{
    \redstoo{(\open{(\C{new} \; \RgnZ\inang{T}\inang{\rgn_r}(v_r))}
                   {\rgn}{x}{e_b},\rhomap)} 
            {\invalidexn}
	  }{EXCEPTION}

%
\bigskip

\textbf{Evaluation Context} \fbox {\(E\)}\\
\begin{smathpar}
\begin{array}{lcl}
E & \coloneqq & \bullet \ALT (\bullet).f \ALT \bullet.m\inang{\ralloc\rbar}(\ebar) \ALT
      v.m\inang{\ralloc\rbar}(...,\bullet,...) \ALT \C{new}\; \fbN(...,\bullet,...) \ALT
      \C{new} \; \RgnZ\inang{T}\inang{\toprgn}(\bullet) \ALT \bullet\inang{\ralloc\rbar}(\ebar) \\
  &  & \ALT v\inang{\ralloc\rbar}(...,\bullet,...) \ALT \open{\bullet}{\rgn}{y}{e}
\end{array}
\end{smathpar}

\caption{\fbname: Operational Semantics (Part 1)}
\label{fig:fb-opsem-1}
\end{figure*}

\begin{figure*}[t!]

\lopsemrule{3.2in}{
%   \fresh(\rgn')\spc
    \redsto{\rhoenv \cup \{\rgn\}}{(e,\rhomap)}{(e',\rhomap')}
}{
    \redstoo{(\letregion{\rgn}{e},\rhomap)}{(\letregion{\rgn}{e'},\rhomap')}
  }{LET-REGION}

\lopsemrule{3in}{
%   \rgn \notin \rhoenv
}{
    \redstoo{(\letregion{\rgn}{v},\rhomap)}{(v,\rhomap)}
  }{LET-REGION-END}

\lopsemrule{3.3in}{
%   \fgjN = \RgnZ\inang{T} \spc
    \ralloc \in \rhoenv \spc
%   We need Delta here to ensure Delta U {pi_r} in next rule is sound. 
    \rgn_r \notin \Delta \cup dom(\Sigma) \spc
%   \rgn \notin dom(\rhomap) \cup \rhoenv \spc
    \rhomap' = \rhomap[\rgn_r \mapsto \CLOSED]
}{
    \redstoo{(\C{new} \; \RgnZ\inang{T}\inang{\toprgn}
                (\lambdaexp{\ralloc}{\rhoalloc}{}{e}),\rhomap)}
            {(\C{new} \; \RgnZ\inang{T}\inang{\rgn_r}
                ([\rgn_r/\rhoalloc]e),\rhomap')}
	      }{NEW-REGION}

\lopsemrule{2.8in}{
    \redsto{\Delta \cup \{\rgn_r\}}{(e,\rhomap)}{(e',\rhomap')} \spc
%   \fgjN = \RgnZ\inang{T} \spc
    \rgn_r \in dom(\rhomap)
}{
    \redstoo{(\C{new} \; \RgnZ\inang{T}\inang{\rgn_r}
                (e),\rhomap)}
            {(\C{new} \; \RgnZ\inang{T}\inang{\rgn_r}
                (e'),\rhomap')}
	      }{NEW-REGION}

\lopsemrule{2.7in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn_r}(v_r) \spc
    \rhomap(\rgn_r) \neq \XFERRED \spc
%   \rgn_0 \notin \rhoenv \spc
}{
    \redstoo{(\open{v_a}{\rgn}{x}{v_b},\rhomap)} {(v_b,\rhomap)}
  }{OPEN-END}


\lopsemrule{4in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn_r}(v_r) \spc
    \rhomap(\rgn_r) \neq \XFERRED \\
%   \fresh(\rgn_1)\\
%   \rgn_0 \notin \rhoenv \\
    \redsto{\Delta \cup \{\rgn\}}{([v_r/x]e_b,
      \rhomap[\rgn_r \mapsto \OPEN])}{(e_b',\rhomap')} \spc
%   \rhomap'' = \rhomap'[\rgn_r \mapsto \rhomap(\rgn_r)]
}{
    \redstoo{(\open{v_a}{\rgn}{x}{e_b},\rhomap)} 
            {(\open{v_a}{\rgn}{x}{e_b'},\rhomap')}
	  }{OPEN}

\lopsemrule{3in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn_r}(v_r) \spc
    \rhomap(\rgn_r) = \XFERRED
%   \rgn_0 \notin \rhoenv \\
%   \redstocup{\rgn_0}{([[\rgn_0/\rgn]v_r/x]e_b,
%     \rhomap[\rgn \mapsto \OPEN])}{(e_b',\rhomap')}
}{
    \redstoo{(\open{v_a}{\rgn}{x}{e_b},\rhomap)} 
            {\invalidexn}
	  }{OPEN-TRANSFERRED}


\lopsemrule{3.25in}{
%   \ralloc \in \rhoenv \spc
%   \fbN = \RgnZ\inang{T}\inang{\rgn_r}\spc
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
    \rhomap(\rgn_r) \neq \OPEN \spc
    \rhomap' = \rhomap[\rgn_r \mapsto \XFERRED]
}{
    \redstoo{((\C{new}\;\RgnZ\inang{T}\inang{\rgn_r}(v)).\transfer\inang{\ralloc}
                      (),\rhomap)}
            {(\unitval,\rhomap')}
	  }{TRANSFER}

\lopsemrule{2.5in}{
%   \fbN = \RgnZ\inang{T}\inang{\rgn}\spc
%   \ralloc \in \rhoenv \spc
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
    \rhomap(\rgn_r) = \OPEN \spc
}{
    \redstoo{((\C{new}\;\RgnZ\inang{T}\inang{\rgn_r}(v)).\transfer\inang{\ralloc}
                      (),\rhomap)}
            {\invalidexn}
	  }{TRANSFER-OPENED}


\caption{\fbname: Operational Semantics (Part 2)}
\label{fig:fb-opsem-2}
\end{figure*}
