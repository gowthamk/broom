\newcommand{\opsemrule}[3]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
\RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}
%
\newcommand{\anobjty}[0]{B\inang{\tbar}\inang{\ralloc\rbar}}
\newcommand{\anobj}[0]{\C{new} \; \anobjty(\bar{v})}
%

\begin{figure*}[t!]

%
\fbox {\(\redstoo{(e,\rhomap)}{(e',\rhomap')}\)}\\

%
\opsemrule{2.7in}{
    \allocRgn(\fbN) \in \rhoenv \spc
    \fields(\fbN) = \bar{f}:\taubar
}{
    \redstoo{((\C{new} \; \fbN(\vbar)).f_i,\rhomap)}{(v_i,\rhomap)}
}
%
\opsemrule{3.2in}{
    \fresh(\rgn')\spc
%   \rgn \notin \rhoenv \spc
    \redsto{\rhoenv \cup \{\rgn'\}}{([\rgn'/\rgn]e,\rhomap)}{(e',\rhomap')}
}{
    \redstoo{(\letregion{\rgn}{e},\rhomap)}{(\letregion{\rgn'}{e'},\rhomap')}
}
%
\opsemrule{3in}{
%   \rgn \notin \rhoenv
}{
    \redstoo{(\letregion{\rgn}{v},\rhomap)}{(v,\rhomap)}
}
%
\opsemrule{3.3in}{
    \fgjN = \RgnZ\inang{T} \spc
    \ralloc \in \rhoenv \spc
    \fresh(\rgn)\spc
%   \rgn \notin dom(\rhomap) \cup \rhoenv \spc
    \rhomap' = \rhomap[\rho \mapsto \CLOSED]
}{
    \redstoo{(\C{new} \; \fgjN\inang{\toprgn}
                (\lambdaexp{\ralloc}{\rhoalloc}{}{e}),\rhomap)}
            {(\C{new} \; \fgjN\inang{\rgn}
                ([\rgn/\rhoalloc]e),\rhomap')}
}
%
\opsemrule{2.8in}{
    \redsto{\{\rgn\}}{(e,\rhomap)}{(e',\rhomap')}\\
    \fgjN = \RgnZ\inang{T} \spc
    \rgn \in dom(\rhomap)
}{
    \redstoo{(\C{new} \; \fgjN\inang{\rgn}
                (e),\rhomap)}
            {(\C{new} \; \fgjN\inang{\rgn}
                (e'),\rhomap')}
}
%
\opsemrule{2.7in}{
    \\
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn}(v_r) \spc
    \rhomap(\rgn) \neq \XFERRED \spc
%   \rgn_0 \notin \rhoenv \spc
}{
    \redstoo{(\open{v_a}{\rgn_0}{x}{v_b},\rhomap)} {(v_b,\rhomap)}
}
%
\opsemrule{1.2in}{
    \\
    \redstoo{(e,\rhomap)}{\invalidexn}
}{
    \redstoo{(E\lbrack e \rbrack, \rhomap)}
            {\invalidexn}
}
%

%
\opsemrule{4in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn}(v_r) \spc
    \rhomap(\rgn) \neq \XFERRED \spc
    \fresh(\rgn_1)\\
%   \rgn_0 \notin \rhoenv \\
    \redsto{\{\rgn_1\}}{([\rgn_1/\{\rgn,\rgn_0\}][v_r/x]e_b,
      \rhomap[\rgn \mapsto \OPEN])}{(e_b',\rhomap')} \spc
    \rhomap'' = \rhomap'[\rgn \mapsto \rhomap(\rgn)]
}{
    \redstoo{(\open{v_a}{\rgn_0}{x}{e_b},\rhomap)} 
            {(\open{v_a}{\rgn_1}{x}{e_b'},\rhomap'')}
}
%
%
\opsemrule{3in}{
    \\
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn}(v_r) \spc
    \rhomap(\rgn) = \XFERRED \\
%   \rgn_0 \notin \rhoenv \\
%   \redstocup{\rgn_0}{([[\rgn_0/\rgn]v_r/x]e_b,
%     \rhomap[\rgn \mapsto \OPEN])}{(e_b',\rhomap')}
}{
    \redstoo{(\open{v_a}{\rgn_0}{x}{e_b},\rhomap)} 
            {\invalidexn}
}
%
%
\opsemrule{3.85in}{
    \allocRgn(\fbN),\ralloc \in \rhoenv \spc
    \mbody(m\inang{\ralloc \rbar},\fbN) = \bar{x}.e 
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
}{
    \redstoo{((\C{new}\;\fbN(\bar{v})).m\inang{\ralloc \rbar}
                      (\bar{v'}),\rhomap)}
            {([\bar{v'}/\xbar][\C{new} \; \fbN(\bar{v})/\thisZ]\,e,\rhomap)}
}
%
\opsemrule{3.25in}{
%   \ralloc \in \rhoenv \spc
    \fbN = \RgnZ\inang{T}\inang{\rgn}\spc
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
    \rhomap(\rgn) \neq \OPEN \spc
    \rhomap' = \rhomap[\rgn \mapsto \XFERRED]
}{
    \redstoo{((\C{new}\;\fbN(v)).\transfer\inang{\ralloc}
                      (),\rhomap)}
            {(\unitval,\rhomap')}
}
%

%
\opsemrule{2.5in}{
    \fbN = \RgnZ\inang{T}\inang{\rgn}\spc
%   \ralloc \in \rhoenv \spc
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
    \rhomap(\rgn) = \OPEN \spc
}{
    \redstoo{((\C{new}\;\fbN(v)).\transfer\inang{\ralloc}
                      (),\rhomap)}
            {\invalidexn}
}
%
\opsemrule{2.85in}{
    v_a = \lambdaexp{\rgn_a}{\rhoalloc\rhobar}
                        {\taubar \; \xbar}{e} \spc
    \rgn_a,\ralloc \in \rhoenv \spc 
}{
    \redstoo{(v_a\inang{\ralloc\rbar}(\bar{v}) ,\rhomap)}
            {([\bar{v}/\xbar][\rbar/\rhobar][\ralloc/\rhoalloc]\,e,\rhomap)}
}
% 
\opsemrule{1.5in}{
    \redstoo{(e,\rhomap)}{(e',\rhomap')}
}{
    \redstoo{(E\lbrack e \rbrack, \rhomap)}
            {(E\lbrack e' \rbrack, \rhomap')}
}
%

%
\opsemrule{2in}{
%   \rgn \notin \rhoenv \spc
    \fresh(\rgn')\\
    \redsto{\rhoenv \cup \{\rgn'\}}{([\rgn'/\rgn]e,\rhomap)}{\invalidexn}
}{
    \redstoo{(\letregion{\rgn}{e},\rhomap)}{\invalidexn}
}
%
\opsemrule{2in}{
    \fgjN = \RgnZ\inang{T} \spc
    \rgn \in dom(\rhomap) \\
    \redsto{\{\rgn\}}{(e,\rhomap)}{\invalidexn}
}{
    \redstoo{(\C{new} \; \fgjN\inang{\rgn}
                (e),\rhomap)}
            {\invalidexn}
}
%
\opsemrule{2.5in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn}(v_r) \spc
    \rhomap(\rgn) \neq \XFERRED \spc
    \fresh(\rgn_1)\\
%  \rgn_0 \notin \rhoenv \\
    \redsto{\{\rgn_1\}}{([\rgn_1/\{\rgn,\rgn_0\}][v_r/x]e_b,
      \rhomap[\rgn \mapsto \OPEN])}{\invalidexn}
}{
    \redstoo{(\open{v_a}{\rgn_0}{x}{e_b},\rhomap)} 
            {\invalidexn}
}
%

%
\bigskip

\textbf{Evaluation Context} \fbox {\(E\)}\\
\begin{smathpar}
\begin{array}{lcl}
E & \coloneqq & \bullet \ALT (\bullet).f \ALT \bullet.m\inang{\ralloc\rbar}(\ebar) \ALT
      v.m\inang{\ralloc\rbar}(...,\bullet,...) \ALT \C{new}\; \fbN(...,\bullet,...) \ALT
      \C{new} \; \RgnZ\inang{T}\inang{\toprgn}(\bullet) \ALT \bullet\inang{\ralloc\rbar}(\ebar) \\
  &  & \ALT v\inang{\ralloc\rbar}(...,\bullet,...) \ALT \open{\bullet}{\rgn}{y}{e}
\end{array}
\end{smathpar}

\caption{\fbname: Operational Semantics}
\label{fig:fb-opsem}
\end{figure*}
