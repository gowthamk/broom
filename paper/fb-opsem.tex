\newcommand{\opsemrule}[3]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
\RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}
\newcommand{\lopsemrule}[4]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
[\rulelabel{#4}] \spc \RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}
%
\newcommand{\anobjty}[0]{B\inang{\tbar}\inang{\ralloc\locbar}}
\newcommand{\anobj}[0]{\C{new} \; \anobjty(\bar{v})}
%


\begin{figure*}[t!]

%
\fbox {\(\redstoo{\Delta}{(e,\mem)}{(e',\mem')}\)}\\

\lopsemrule{3.2in}{
%   \fresh(\rgn')\spc
%   \mem(\loc) = \FREE \spc
    \loc \not\in dom(\mem) \spc
    \mem' = \mem[\loc \mapsto \SLIVE]
%   \redstoo{\Delta}{(e,\mem)}{(e',\mem')}
}{
    \redstoo{\Delta}{(\letregion{\rgn}{e},\mem)}{(\letd{\loc}{[\loc/\rgn]e},\mem')}
  }{LetRegionBegin}

\lopsemrule{3in}{
    \redstocup{\loc}{(e,\mem)}{(e',\mem')}
}{
    \redstoo{\Delta}{(\letd{\loc}{e},\mem)}{(\letd{\loc}{e'},\mem')}
  }{LetRegion}

\lopsemrule{3in}{
%   \rgn \notin \rhoenv
%   \mem' = \mem[\loc \mapsto \FREE]
    \mem' = \mem[\loc \mapsto \XFERRED]
}{
    \redstoo{\Delta}{(\letd{\loc}{v},\mem)}{(v,\mem)}
  }{LetRegionEnd}

\lopsemrule{3.3in}{
    \loc \not\in dom(\mem) \spc
    \mem' = \mem[\loc \mapsto \USED]
}{
    \redstoo{\Delta}{(\C{new} \; \RgnZ\inang{T}\inang{\toprgn}
                (v),\mem)}
            {(\C{new} \; \RgnZ\inang{T}\inang{\toploc\loc}
                (v\inang{\loc}()),\mem')}
	      }{NewRegion}

\lopsemrule{3.3in}{
%   \mem(\loc) = \USED \spc % Type system cannot guarantee this.
    \redstocup{\loc}{(e,\mem[\loc \mapsto \LIVE]) }{(e',\mem')}
}{
    \redstoo{\Delta}{(\C{new} \; \RgnZ\inang{T}\inang{\toploc\loc}
                (e),\mem)}
            {(\C{new} \; \RgnZ\inang{T}\inang{\toploc\loc}
                (e'),\mem')} %[\loc\mapsto\USED])}
	      }{NewRegion}

\lopsemrule{4in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\toploc\loc}(v) \spc
    \mem(\loc) = \USED ~\texttt{or}~ \mem(\loc) = \TLIVE \spc
%   \fresh(\rgn_1)\\
%   \rgn_0 \notin \rhoenv \\
    \mem' = \mem[\loc \mapsto \TLIVE]
%   \mem'' = \mem'[\rgn_r \mapsto \mem(\rgn_r)]
}{
    \redstoo{\Delta}{(\open{v_a}{\rgn}{x}{e_b},\mem)} 
            {(\opened{\loc}{\mem(\loc)}{[v/x][\loc/\rgn]e_b},\mem')}
	  }{Open}

\lopsemrule{2.7in}{
    \redstocup{\loc}{(e,\mem)}{(e',\mem')}
}{
    \redstoo{\Delta}{(\opened{\loc}{\status}{e},\mem)}
    {(\opened{\loc}{\status}{e'},\mem')}
  }{Opened}

\lopsemrule{2.7in}{
    \mem' = \mem[\loc \mapsto \status]
}{
    \redstoo{\Delta}{(\opened{\loc}{\status}{v},\mem)} {(v,\mem')}
  }{OpenEnd}


\lopsemrule{3in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\toploc\loc}(v) \spc
    \mem(\loc) \neq \USED ~\texttt{and}~ \mem(\loc) \neq \LIVE
}{
    \redstoo{\Delta}{(\open{v_a}{\rgn}{x}{e_b},\mem)} 
            {\invalidexn}
	  }{OpenTransferred}


\lopsemrule{3.25in}{
    \mem(\loc) = \USED \spc
    \mem' = \mem[\loc \mapsto \XFERRED]
}{
    \redstoo{\Delta}{((\C{new}\;\RgnZ\inang{T}\inang{\toploc\loc}(v)).\transfer(),\mem)}
            {(\unitval,\mem')}
	  }{Transfer}

\lopsemrule{2.5in}{
    \mem(\loc) = \TLIVE \spc
}{
    \redstoo{\Delta}{((\C{new}\;\RgnZ\inang{T}\inang{\toploc\loc}(v)).\transfer(),\mem)}
            {\invalidexn}
	  }{TransferOpened}

\caption{\fbname: a select subset of operational semantics }
\label{fig:fb-opsem}
\end{figure*}
