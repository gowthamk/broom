\newcommand{\redstoo}[2]{\redsto{\rhoenv}{#1}{#2}}
\newcommand{\redstocup}[3]{\redsto{\rhoenv \cup \{#1\}}{#2}{#3}}
\newcommand{\anobjty}[0]{B\inang{\tbar}\inang{\ralloc\rbar}}
\newcommand{\anobj}[0]{\C{new} \; \anobjty(\bar{v})}
\begin{figure*}[t!]

%
\fbox {\(\redstoo{(e,\rhomap)}{(e',\rhomap')}\)}\\

%
\begin{minipage}{2.7in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \allocRgn(\fbN) \in \rhoenv \spc
    \fields(\fbN) = \taubar\;\bar{f}
  }
  {
    \redstoo{((\C{new} \; \fbN(\vbar)).f_i,\rhomap)}{(v_i,\rhomap)}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
% \begin{minipage}{3in}
% \begin{smathpar}
% \begin{array}{c}
% \renewcommand*{\arraystretch}{1.2}
% \RULE
%   {
%     \ralloc \in \rhoenv \spc
%     \redstoo{(e_i,\rhomap)}{(e_i',\rhomap')}
%   }
%   {
%     \redstoo{(\C{new} \; \fbN(...,e_i,...),\rhomap)}
%             {(\C{new} \; \fbN(...,e_i',...),\rhomap')}
%   }
% \end{array}
% \end{smathpar}
% \end{minipage}
%
\begin{minipage}{3.2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \rgn \notin \rhoenv \spc
    \redsto{\rhoenv \cup \{\rgn\}}{(e,\rhomap)}{(e',\rhomap')}
  }
  {
    \redstoo{(\letregion{\rgn}{e},\rhomap)}{(\letregion{\rgn}{e'},\rhomap')}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\begin{minipage}{3in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \rgn \notin \rhoenv
  }
  {
    \redstoo{(\letregion{\rgn}{v},\rhomap)}{(v,\rhomap)}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{3.3in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \fgjN = \RgnZ\inang{T} \spc
    \ralloc \in \rhoenv \spc
    \rgn \notin dom(\rhomap) \cup \rhoenv \spc
    \rhomap' = \rhomap[\rho \mapsto \CLOSED]
  }
  {
    \redstoo{(\C{new} \; \fgjN\inang{\toprgn}
                (\lambdaexp{\ralloc}{\rhoalloc}{}{e}),\rhomap)}
            {(\C{new} \; \fgjN\inang{\rgn}
                ([\rgn/\rhoalloc]e),\rhomap')}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\begin{minipage}{3.6in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \fgjN = \RgnZ\inang{T} \spc
    \rgn \in dom(\rhomap) \spc
    \redstocup{\rgn}{(e,\rhomap)}{(e',\rhomap')}
  }
  {
    \redstoo{(\C{new} \; \fgjN\inang{\rgn}
                (e),\rhomap)}
            {(\C{new} \; \fgjN\inang{\rgn}
                (e'),\rhomap')}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{2.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn}(v_r) \spc
    \rhomap(\rgn) \neq \XFERRED \spc
    \rgn_0 \notin \rhoenv \spc
  }
  {
    \redstoo{(\open{v_a}{\rgn_0}{x}{v_b},\rhomap)} {(v_b,\rhomap)}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\begin{minipage}{4in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn}(v_r) \spc
    \rhomap(\rgn) \neq \XFERRED \spc
    \rgn_0 \notin \rhoenv \\
    \redstocup{\rgn_0}{([[\rgn_0/\rgn]v_r/x]e_b,
      \rhomap[\rgn \mapsto \OPEN])}{(e_b',\rhomap')} \spc
    \rhomap'' = \rhomap'[\rgn \mapsto \rhomap(\rgn)]
  }
  {
    \redstoo{(\open{v_a}{\rgn_0}{x}{e_b},\rhomap)} 
            {(\open{v_a}{\rgn_0}{x}{e_b'},\rhomap'')}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{3in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \\
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn}(v_r) \spc
    \rhomap(\rgn) = \XFERRED \spc
%   \rgn_0 \notin \rhoenv \\
%   \redstocup{\rgn_0}{([[\rgn_0/\rgn]v_r/x]e_b,
%     \rhomap[\rgn \mapsto \OPEN])}{(e_b',\rhomap')}
  }
  {
    \redstoo{(\open{v_a}{\rgn_0}{x}{e_b},\rhomap)} 
            {\invalidexn}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\begin{minipage}{3.85in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \allocRgn(\fbN),\ralloc \in \rhoenv \spc
    \mbody(m\inang{\ralloc \rbar},\fbN) = \bar{x}.e 
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
  }
  {
    \redstoo{((\C{new}\;\fbN(\bar{v})).m\inang{\ralloc \rbar}
                      (\bar{v'}),\rhomap)}
            {([\bar{v'}/\xbar][\C{new} \; \fbN(\bar{v})/\thisZ]\,e,\rhomap)}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{3.25in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
%   \ralloc \in \rhoenv \spc
    \fbN = \RgnZ\inang{T}\inang{\rgn}\spc
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
    \rhomap(\rgn) \neq \OPEN \spc
    \rhomap' = \rhomap[\rgn \mapsto \XFERRED]
  }
  {
    \redstoo{((\C{new}\;\fbN(v)).\transfer\inang{\ralloc}
                      (),\rhomap)}
            {(\unitval,\rhomap')}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\begin{minipage}{2.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \fbN = \RgnZ\inang{T}\inang{\rgn}\spc
%   \ralloc \in \rhoenv \spc
%   \redstoo{(, \rhomap)}{(e',\rhomap')}
    \rhomap(\rgn) = \OPEN \spc
  }
  {
    \redstoo{((\C{new}\;\fbN(v)).\transfer\inang{\ralloc}
                      (),\rhomap)}
            {\invalidexn}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{2.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    v_a = \lambdaexp{\rgn_a}{\rhoalloc\rhobar}
                        {\taubar \; \xbar}{e} \spc
    \rgn_a,\ralloc \in \rhoenv \spc 
  }
  {
    \redstoo{(v_a\inang{\ralloc\rbar}(\bar{v}) ,\rhomap)}
            {([\bar{v}/\xbar][\rbar/\rhobar][\ralloc/\rhoalloc]\,e,\rhomap)}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
% %
% \begin{minipage}{1.8in}
% \begin{smathpar}
% \begin{array}{c}
% \renewcommand*{\arraystretch}{1.2}
% \RULE
%   {
%     \redstoo{(e_1,\rhomap)}{(e_1',\rhomap')}
%   }
%   {
%     \redstoo{(e_1;\,e_2,\rhomap)}
%             {(e_1';\,e_2,\rhomap')}
%   }
% \end{array}
% \end{smathpar}
% \end{minipage}
% %

\begin{minipage}{1.8in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    
  }
  {
    \redstoo{(\unitval;\,e_2,\rhomap)}
            {(e_2,\rhomap)}
  }
\end{array}
\end{smathpar}
\end{minipage}
% 
\begin{minipage}{1.8in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \redstoo{(e,\rhomap)}{(e',\rhomap')}
  }
  {
    \redstoo{(E\lbrack e \rbrack, \rhomap)}
            {(E\lbrack e' \rbrack, \rhomap')}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{1.2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \redstoo{(e,\rhomap)}{\invalidexn}
  }
  {
    \redstoo{(E\lbrack e \rbrack, \rhomap)}
            {\invalidexn}
  }
\end{array}
\end{smathpar}
\end{minipage}

%
\begin{minipage}{2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \\
    \rgn \notin \rhoenv \spc
    \redsto{\rhoenv \cup \{\rgn\}}{(e,\rhomap)}{\invalidexn}
  }
  {
    \redstoo{(\letregion{\rgn}{e},\rhomap)}{\invalidexn}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \fgjN = \RgnZ\inang{T} \spc
    \rgn \in dom(\rhomap) \\
    \redstocup{\rgn}{(e,\rhomap)}{\invalidexn}
  }
  {
    \redstoo{(\C{new} \; \fgjN\inang{\rgn}
                (e),\rhomap)}
            {\invalidexn}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
\begin{minipage}{2.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\rgn}(v_r) \spc
    \rhomap(\rgn) \neq \XFERRED \spc
    \rgn_0 \notin \rhoenv \\
    \redstocup{\rgn_0}{([[\rgn_0/\rgn]v_r/x]e_b,
      \rhomap[\rgn \mapsto \OPEN])}{\invalidexn}
  }
  {
    \redstoo{(\open{v_a}{\rgn_0}{x}{e_b},\rhomap)} 
            {\invalidexn}
  }
\end{array}
\end{smathpar}
\end{minipage}
%

%
\bigskip

\textbf{Evaluation Context} \fbox {\(E\)}\\
\begin{smathpar}
\begin{array}{lcl}
E & \coloneqq & \bullet \ALT (\bullet).f \ALT \bullet.m\inang{\ralloc\rbar}(\ebar) \ALT
      v.m\inang{\ralloc\rbar}(...,\bullet,...) \ALT \C{new}\; \fbN(...,\bullet,...) \ALT
      \C{new} \; \RgnZ\inang{T}\inang{\toprgn}(\bullet) \ALT \bullet\inang{\ralloc\rbar}(\ebar) \\
  &  & \ALT v\inang{\ralloc\rbar}(...,\bullet,...) \ALT \bullet;\,e \ALT \open{\bullet}{\rgn}{y}{e}
\end{array}
\end{smathpar}

\caption{\fbname: Operational Semantics}
\label{fig:fb-opsem}
\end{figure*}
