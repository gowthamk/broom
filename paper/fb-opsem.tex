\newcommand{\opsemrule}[3]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
\RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}
\newcommand{\lopsemrule}[4]{%
\begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
\renewcommand*{\arraystretch}{1.2}%
[\rulelabel{#4}] \spc \RULE {#2} {#3}%
\end{array}\end{smathpar}\end{minipage}%
}
%
\newcommand{\anobjty}[0]{B\inang{\tbar}\inang{\ralloc\locbar}}
\newcommand{\anobj}[0]{\C{new} \; \anobjty(\bar{v})}
%

\begin{figure*}[t!]

%
\fbox {\(\redstoo{(e,\mem)}{(e',\mem')}\)}\\

\lopsemrule{1.5in}{
    \redstoo{(e,\mem)}{(e',\mem')}
}{
    \redstoo{(E\lbrack e \rbrack, \mem)}
            {(E\lbrack e' \rbrack, \mem')}
	  }{EVAL-ORDER}

\lopsemrule{1.2in}{
    \redstoo{(e,\mem)}{\invalidexn}
  }{
    \redstoo{(E\lbrack e \rbrack, \mem)}
            {\invalidexn}
	  }{EXCEPTION}
%

\lopsemrule{2.7in}{
%   \allocRgn(A\inang{\rgn\locbar}\inang{\tbar}) & = & \rgn
%   \allocRgn(\fbN) \in \rhoenv \spc
    \mem(\loc) = \LIVE \spc
    \fields(A\inang{\loc\locbar}) = \bar{f}:\taubar
}{
    \redstoo{((\C{new} \; A\inang{\loc\locbar}(\vbar)).f_i,\mem)}{(v_i,\mem)}
}{FIELD-ACCESS}

\lopsemrule{3.85in}{
%   \allocRgn(\fbN) \in \rhoenv \spc
    \mem(\loc) = \LIVE \spc
    \mbody(m,A\inang{\loc\locbar}) = \rhobar.\bar{x}.e 
%   \redstoo{(, \mem)}{(e',\mem')}
}{
    \redstoo{((\C{new}\;A\inang{\loc\locbar}(\bar{v})).m\inang{\overline{\loc'}}
                      (\bar{v'}),\mem)}
            {([\overline{\loc'}/\rhobar][\bar{v'}/\xbar]
                [\C{new} \; A\inang{\loc\locbar}(\bar{v})/\thisZ]\,e,\mem)}
	  }{METHOD-INV}

\lopsemrule{2.85in}{
    v_a = \lambdaexp{\loc}{\rhobar}
                        {\taubar \; \xbar}{e} \spc
    \mem(\loc) = \LIVE  \spc 
}{
    \redstoo{(v_a\inang{\locbar}(\bar{v}) ,\mem)}
            {([\bar{v}/\xbar][\locbar/\rhobar]\,e,\mem)}
	  }{FUN-APPLY}

%
% \lopsemrule{2in}{
% %   \rgn \notin \rhoenv \spc
% %   \fresh(\rgn') \spc
%     \redstoo{(e,\mem)}{\invalidexn}
% }{
%     \redstoo{(\letregion{\rgn}{e},\mem)}{\invalidexn}
%   }{EXCEPTION}

\lopsemrule{2in}{
%   \fgjN = \RgnZ\inang{T} \spc
%   \rgn \in dom(\mem) \spc
    \redstoo{(e,\mem[\loc \mapsto \LIVE])}{\invalidexn}
}{
    \redstoo{(\C{new} \; \RgnZT{\loc} (e),\mem)}
            {\invalidexn}
	  }{EXCEPTION}

\lopsemrule{3.2in}{
    \not\exists \loc.~\mem(\loc) = \FREE
}{
    \redstoo{(\letregion{\rgn}{e},\mem)}{\invalidexn}
  }{EXCEPTION}


\lopsemrule{3.3in}{
    \not\exists \loc.~\mem(\loc) = \FREE
}{
    \redstoo{(\C{new} \; \RgnZ\inang{T}\inang{\toprgn}
                (\lambdaexp{\loc'}{\rho}{}{e}),\mem)}
            {\invalidexn}
	      }{EXCEPTION}
% \lopsemrule{2.5in}{
%     \mem(\rgn_r) \neq \XFERRED \spc
% %   \fresh(\rgn_1) \spc
% %  \rgn_0 \notin \rhoenv \\
%     \redsto{\Delta \cup \{\rgn\}}{([[\rgn/\rgn_r]v_r/x]e_b,
%       \mem[\rgn_r \mapsto \OPEN])}{\invalidexn}
% }{
%     \redstoo{(\open{(\C{new} \; \RgnZ\inang{T}\inang{\rgn_r}(v_r))}
%                    {\rgn}{x}{e_b},\mem)} 
%             {\invalidexn}
%     }{EXCEPTION}

%
\bigskip

\textbf{Evaluation Context} \fbox {\(E\)}\\
\begin{smathpar}
\begin{array}{lcl}
E & \coloneqq & \bullet \ALT (\bullet).f \ALT \bullet.m\inang{\locbar}(\ebar) \ALT
      v.m\inang{\locbar}(...,\bullet,...) \ALT \C{new}\; \fbN(...,\bullet,...) \ALT
      \C{new} \; \RgnZ\inang{T}\inang{\loc}(\bullet) \ALT \bullet\inang{\locbar}(\ebar) \\
  &  & \ALT v\inang{\locbar}(...,\bullet,...) \ALT
       \letregion{\loc}{\bullet} \ALT \open{\bullet}{\rgn}{y}{e} \ALT
       \opened{\loc}{\bullet}
\end{array}
\end{smathpar}

\caption{\fbname: Operational Semantics (Part 1)}
\label{fig:fb-opsem-1}
\end{figure*}

\begin{figure*}[t!]

\lopsemrule{3.2in}{
%   \fresh(\rgn')\spc
    \mem(\loc) = \FREE \spc
    \mem' = \mem[\loc \mapsto \SLIVE]
%   \redstoo{(e,\mem)}{(e',\mem')}
}{
    \redstoo{(\letregion{\rgn}{e},\mem)}{(\letregion{\loc}{[\loc/\rgn]e},\mem')}
  }{LET-REGION-BEGIN}

\lopsemrule{3in}{
%   \rgn \notin \rhoenv
    \mem' = \mem[\loc \mapsto \FREE]
}{
    \redstoo{(\letregion{\loc}{v},\mem)}{(v,\mem)}
  }{LET-REGION-END}

\lopsemrule{3.3in}{
%   \fgjN = \RgnZ\inang{T} \spc
%   \rgn \in \rhoenv \spc
%   We need Delta here to ensure Delta U {pi_r} in next rule is sound. 
%   \rgn_r \notin \Delta \cup dom(\Sigma) \spc
%   \rgn \notin dom(\mem) \cup \rhoenv \spc
%   \mem' = \mem[\rgn_r \mapsto \CLOSED]
    \mem(\loc) = \LIVE \spc
    \mem(\loc') = \FREE \spc
    \mem' = \mem[\loc' \mapsto \USED]
}{
    \redstoo{(\C{new} \; \RgnZ\inang{T}\inang{\toprgn}
                (\lambdaexp{\rgn}{\rho}{}{e}),\mem)}
            {(\C{new} \; \RgnZ\inang{T}\inang{\loc'}
                ([\loc'/\rho]e),\mem')}
	      }{NEW-REGION}

% \lopsemrule{2.8in}{
%     \redsto{\Delta \cup \{\rgn_r\}}{(e,\mem)}{(e',\mem')} \spc
% %   \fgjN = \RgnZ\inang{T} \spc
%     \rgn_r \in dom(\mem)
% }{
%     \redstoo{(\C{new} \; \RgnZ\inang{T}\inang{\rgn_r}
%                 (e),\mem)}
%             {(\C{new} \; \RgnZ\inang{T}\inang{\rgn_r}
%                 (e'),\mem')}
%         }{NEW-REGION}

\lopsemrule{4in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\loc}(v) \spc
    \mem(\loc) = \USED ~\texttt{or}~ \mem(\loc) = \TLIVE \spc
%   \fresh(\rgn_1)\\
%   \rgn_0 \notin \rhoenv \\
    \mem' = \mem[\loc \mapsto \TLIVE]
%   \mem'' = \mem'[\rgn_r \mapsto \mem(\rgn_r)]
}{
    \redstoo{(\open{v_a}{\rgn}{x}{e_b},\mem)} 
            {(\opened{\loc}{[v/x][\loc/\rgn]e_b},\mem')}
	  }{OPEN}

\lopsemrule{2.7in}{
%   v_a = \C{new} \; \RgnZ\inang{T}\inang{\}(v_r) \spc
%   \mem(\rgn_r) \neq \XFERRED \spc
%   \rgn_0 \notin \rhoenv \spc
    \mem' = \mem[\loc \mapsto \USED]
}{
    \redstoo{(\opened{\loc}{v},\mem)} {(v,\mem')}
  }{OPEN-END}


\lopsemrule{3in}{
    v_a = \C{new} \; \RgnZ\inang{T}\inang{\loc}(v) \spc
    \mem(\loc) = \XFERRED
%   \rgn_0 \notin \rhoenv \\
%   \redstocup{\rgn_0}{([[\rgn_0/\rgn]v_r/x]e_b,
%     \mem[\rgn \mapsto \OPEN])}{(e_b',\mem')}
}{
    \redstoo{(\open{v_a}{\rgn}{x}{e_b},\mem)} 
            {\invalidexn}
	  }{OPEN-TRANSFERRED}


\lopsemrule{3.25in}{
%   \ralloc \in \rhoenv \spc
%   \fbN = \RgnZ\inang{T}\inang{\rgn_r}\spc
%   \redstoo{(, \mem)}{(e',\mem')}
    \mem(\loc) = \USED \spc
    \mem' = \mem[\loc \mapsto \XFERRED]
}{
    \redstoo{((\C{new}\;\RgnZ\inang{T}\inang{\loc}(v)).\transfer(),\mem)}
            {(\unitval,\mem')}
	  }{TRANSFER}

\lopsemrule{2.5in}{
%   \fbN = \RgnZ\inang{T}\inang{\rgn}\spc
%   \ralloc \in \rhoenv \spc
%   \redstoo{(, \mem)}{(e',\mem')}
    \mem(\loc) = \TLIVE \spc
}{
    \redstoo{((\C{new}\;\RgnZ\inang{T}\inang{\loc}(v)).\transfer(),\mem)}
            {\invalidexn}
	  }{TRANSFER-OPENED}

\lopsemrule{2.5in}{
    \not\exists \loc.~\mem(\loc) = \SLIVE \spc
    \mem(\loc') = \XFERRED
}{
    \redstoo{(e,\mem)}{(e,\mem[\loc'\mapsto\FREE])}
	  }{GARBAGE-COLLECT}


\caption{\fbname: Operational Semantics (Part 2)}
\label{fig:fb-opsem-2}
\end{figure*}
