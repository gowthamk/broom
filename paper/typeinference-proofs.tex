\section{Type Inference: Proofs}

\begin{theorem}
\label{thm:constraint-generation-sc}
Let $C = \consOf{q}$.
An assignment $\soln$ (for the region and predicate variables in $q$)
satisfies $C$ iff $q[\soln]$ is well-typed.
\end{theorem}
\begin{proof}
The correspondence between the static semantics rules and the constraint generation
rules induces a correspondence between derivation trees produced by the
two systems.
% We do not present a formal proof of the theorem.
We can establish the following lemma inductively:
given a derivation tree $\zeta_1$ for
$\exprok {\stdcontext}{e}{\tau}{C}$
and any substitution $\soln$,
we can construct a corresponding \emph{candidate} derivation
tree $\zeta_2$ of $\hastyp {\A[\soln],\env[\soln]}{e[\soln]}{\tau[\soln]}$.
We can show that $\zeta_2$ is a valid derivation tree iff $\soln$ satisfies $C$.
(We make use of analogous lemmas for type well-formedness rules as well.)
\end{proof}

\begin{lemma}
  \label{lemma:gc-is-decomposable}
  Let $C = \consOf{q}$. Every abduction constraint in $C$ is decomposable.
\end{lemma}

\begin{proof}
  By induction over the constraint-generation rules.
  Any context $\A = (\rhoenv,\aenv,\phicx)$ generated by the constraint-generation
  process satisfies the invariant that $\phicx$ is of the form $\varphi \conj \phictxt$
  where $\rhoenv \supseteq \predDeltaMap(\varphi)$.
  The only rule that modifies $\phicx$ is the rule for \C{letregion}
  that adds the set of constraints $\pi_f \outlives \pi$ for every $\pi_f \in \rhoenv$
  as conjuncts to $\phicx$.
\end{proof}

\begin{lemma}
  \label{lemma:decomposition}
  Consider any decomposable constraint  $\isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j}$
where both $\pi_i$ and $\pi_j$ are region constants.
(a) If $\{ \pi_i, \pi_j \} \subseteq \predDeltaMap(\varphi)$,
then $\soln$ satisfies $C \cup \{ \isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j} \}$
iff
$\soln$ satisfies $C \cup \{ \isvalid{\varphi}{\pi_i \outlives \pi_j} \}$
  (b) If $\{ \pi_i, \pi_j \} \not \subseteq \predDeltaMap(\varphi)$,
$\soln$ satisfies $C \cup \{ \isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j} \}$
iff
$\soln$ satisfies $C \cup \{ \isvalid{\phi}{\pi_i \outlives \pi_j} \}$
\end{lemma}

\begin{proof}
  Straightforward.
\end{proof}

\begin{theorem}
  \label{thm:closure}
Let $C = \consOf{q}$.
An assignment $\soln$ satisfies $C$ iff $\soln$ satisfies $\satC$.
\end{theorem}

\begin{proof}
  For the forward implication, we use induction to show that every constraint
  added to $\satC$ preserves satisfiability (with respect to an assignment $\soln$).
  The Transitivity and Substitution steps are straightforward. The Abduction Decomposition
  step is justified by Lemmas~\ref{lemma:gc-is-decomposable} and~\ref{lemma:decomposition}.
  The reverse implication is trivial.
\end{proof}

\begin{lemma}
  \label{lemma:completely-bound}
Let $C = \consOf{q}$.
Every region variable occurring in $\satC$ is bound to some region constant in $\satC$.
\end{lemma}

\begin{proof}
The constraint-generation rules guarantee that every region variable will
be unified with some region constant\footnote{
There is one special case where this does not hold: a recursive function
that calls itself in a non-terminating fashion. Such a function never
returns a value, and so the return-value can be typed as anything.
We assume that the return value of such a function is typed to be \C{unit},
which will not introduce any region variables at the call-site of such a function.}
This follows because $\FB$ does not admit uninitialized variables.
% , and the type system uniquely determines the region parameters of every value
\end{proof}

\begin{lemma}
  \label{lemma:two-bindings}
Let $C = \consOf{q}$.
Suppose a region variable $\rho$ is bound to two different region constants $\pi_1$
and $\pi_2$ in a context $\varphi \conj \phi$. % in $\satC$.
Let $\soln$ satisfy $\satC$.
For any context $\varphi \conj \phi$ that contains $\rho$, we must have
$\{ \pi_1, \pi_2 \} \subseteq \predDeltaMap(\varphi)$ and
$\isvalid{\predSubstFn(\varphi)}{\pi_1 = \pi_2}$.
\end{lemma}

\begin{proof}
  Assume that a region variable $\rho$ is bound to two different
  region constants $\pi_1$ and $\pi_2$ in a context $\varphi \conj \phi$.
  By transitivity, $\satC$ is guaranteed to have the constraints
  $\isvalid{\varphi \conj \phi}{\pi_1 \outlives \pi_2}$
  and $\isvalid{\varphi \conj \phi}{\pi_2 \outlives \pi_1}$.
  By abduction decomposition, one of the following conditions must hold:
  (a) $\{ \pi_1, \pi_2 \} \subseteq \predDeltaMap(\varphi)$ and
  both $\isvalid{\varphi}{\pi_1 \outlives \pi_2}$ and
  $\isvalid{\varphi}{\pi_2 \outlives \pi_1}$ are in $\satC$, or
  (b) $\{ \pi_1, \pi_2 \} \not\subseteq \predDeltaMap(\varphi)$ and
  both $\isvalid{\phi}{\pi_1 \outlives \pi_2}$ and
  $\isvalid{\phi}{\pi_2 \outlives \pi_1}$ are in $\satC$.
  In case (b), $\satC$ will not be satisfiable, so we can ignore this case.
  In case (a), $\varphi$ must be bound to a conjunction that includes both
  $\pi_1 \outlives \pi_2$ and $\pi_2 \outlives \pi_1$ in any satisfying assignment
  for $\satC$.
\end{proof}

% \begin{lemma}
% Let $C = \consOf{q}$.
% Let $\satC_1$ denote the subset of $\satC$ obtained by removing all constraints
% that contain a region variable.
% $\satC$ is satisfiable iff $\satC_1$ is satisfiable.
% \end{lemma}
% 
% \begin{proof}
%   The forward implication is trivial.
%   The reverse implication follows from Lemma~\label{lemma:completely-bound}, as shown below.
% \end{proof}

\begin{theorem}
\label{thm:constraint-solver-soundness}
Let $C = \consOf{q}$.
If $\solveCon{C} = \textsc{Some}(\soln)$,
then $\soln$ satisfies $\satC$.
\end{theorem}

\begin{proof}
Assume $\solveCon{C} = \textsc{Some}(\soln)$.

By definition (of $\solveCon{C}$), $\groundC$ (the set of all variable-free constraints in $\satC$)
is satisfiable. Hence, $\soln$ trivially satisfies all constraints in $\groundC$.
%
The definition also ensures that $\soln$ satisfies the well-formedness constraints
for any region variable $\rho$.

Consider any constraint of the form $\isvalid{\varphi}{\pi_i \outlives \pi_j}$ in $\satC$,
where $\pi_i$ and $\pi_j$ are distinct region constants. The definition of $\predSubstFn(\varphi)$
ensures that $\soln$ satisfies this constraint.
Furthermore, $\soln$ must also satisfy the well-formedness constraint
$\tywf{\predDeltaMap(\varphi)}{\varphi}$.
(Otherwise, the application of Abduction Decomposition to this constraint will add
$\isvalid{}{\pi_i \outlives \pi_j}$ to $\satC$. This constraint is invalid, which
contradicts the fact that $\groundC$ is valid.)

Consider any constraint of the form $\isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j}$ in $\satC$,
It follows from abduction decomposition that either
$\isvalid{\varphi}{\pi_i \outlives \pi_j}$
or
$\isvalid{\phi}{\pi_i \outlives \pi_j}$ must be in $\satC$, which we know is satisfied by $\soln$.
Hence, $\soln$ must satisfy
$\isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j}$ as well.

This shows that $\soln$ satisfies all outlives-constraints in $\satC$ that have no variables in the consequent.

Consider any constraint of the form $\isvalid{\ell}{F_j(\varphi_j)}$.
Substituting the value $\predSubstFn(\varphi_j)$ reduces this constraint to one of
the form $\isvalid{\ell}{\conj_i \pi_i \outlives \pi_i'}$ where the substitution rule
guarantees $\isvalid{\ell}{\pi_i \outlives \pi_i'}$ is already in $\satC$ and, hence,
satisfied by $\soln$.
Hence, $\soln$ satisfies $\isvalid{\ell}{F_j(\varphi_j)}$ as well.

Consider any constraint of the form $\isvalid{\ell}{r}$ where $r$ contains a single occurrence
of a region variable, say $\rho$.
It follows from Lemma~\ref{lemma:completely-bound} that $\rho$ is bound to some region
constant $\pi$.
Let $r'$ denote $r$ with $\rho$ replaced by $\pi$.
It follows from the transitivity rule that $\satC$ must contain the constraint $\isvalid{\ell}{r'}$.
Since this constraint has no variables on the consequent, we have already shown that $\soln$
must satisfy this constraint ($\isvalid{\ell}{r'}$).
Let $\pi' = \regionSubstFn(\rho)$.
We can show (as in the proof of Lemma~\ref{lemma:two-bindings}) that $\soln$ satisfies $\isvalid{\ell}{\pi = \pi'}$.
Hence, $\soln$ satisfies $\isvalid{\ell}{r}$ as well.

The same idea works for constraints with occurrences of two region variables in the consequent.

\end{proof}

\begin{theorem}
\label{thm:constraint-solver-completeness}
Let $C = \consOf{q}$.
If $\satC$ is satisfiable, then the constraint solver will return some assignment.
\end{theorem}

\begin{proof}
If $\satC$ is satisfiable, then $\groundC$ is trivially satisfiable.
If $\groundC$ is satisfiable, the solver will fail to return an assignment only if the set $S_\rho$ = 
$\{ \pi \in \regionDeltaMap(\rho) \; | \; \isvalid{\ell}{\rho = \pi} \in \satC \}$ is empty for some region variable $\rho$.
Consider any such $\rho$.
Let $\soln$ be a satisfying assignment for $\satC$.
Let $\pi' = \predSubstFn(\rho)$. Then, we must have $\pi' \in \regionDeltaMap(\rho)$.
From Lemma~\ref{lemma:completely-bound}, $\rho$ must be bound to some $\pi$ in some context $\ell$.
Thus, $\isvalid{\ell}{\rho = \pi} \in \satC$.
Since $\soln$ satisfies this constraint, we have $\isvalid{\ell[\soln]}{\pi' = \pi}$.
If $\pi$ and $\pi'$ are the same region identifier, we have a contradiction, since
$\pi \in S_\rho$ and $S_\rho$ cannot be empty.
If $\pi$ and $\pi'$ are distinct region identifiers, then it follows that the precondition of case (a) must hold
in Lemma~\ref{lemma:decomposition}, and we must have $\{ \pi, \pi' \} \subseteq \predDeltaMap(\varphi)$.
We can show, by induction over the constraint-generation rules, that if $\regionDeltaMap(\rho)$ includes
some element of $\predDeltaMap(\varphi)$, then it includes all elements of $\predDeltaMap(\varphi)$.
It follows that $\pi \in \regionDeltaMap(\rho)$. Hence, the set $S_\rho$ is non-empty (as it contains $\pi$.
The result follows.
\end{proof}

\begin{theorem}
\label{thm:constraint-solver-sc}
Let $C = \consOf{q}$.\\
(Soundness) If $\solveCon{C} = \textsc{Some}(\soln)$, then $\soln$ satisfies $C$.\\
(Completeness) If $\solveCon{C} = \textsc{None}$, then $C$ is unsatisfiable.
\end{theorem}

\begin{proof}

Follows from Theorems~\ref{thm:constraint-solver-soundness} and~\ref{thm:constraint-solver-completeness}.

% Theorem~\ref{thm:closure} shows that $\satC$ and $C$ are equivalent.
% 
% The next step is to show that $\groundC$ and $\satC$ are (almost) equivalent.
% Consider $\satC \setminus \groundC$. This includes the well-formedness constraints.
% It is easy to show that we take care of these.
% 
% The more difficult case are validity constraints, involving either region variables
% ($\rho$) or predicate variables ($\varphi$) or both.
% 
% We use this property to show that it is okay to ignore validity constraints
% in $\satC$ containing region variables. For every
% region variable $\rho$ unified with a constant $\pi$, and for every validity
% constraint containing $\rho$, we will have a corresponding validity constraint
% containing $\pi$ instead.
% 
% As for validity constraints containing a predicate variable $\varphi$ on the consequent,
% we argue that the use of the Substitution rule in computing $\satC$ makes it okay
% to ignore these constraints.
% 
% As for validity constraints containing a predicate variable $\varphi$ on the antecedent,
% we use Lemma~\ref{lemma:decomposition} to argue that Abduction Decomposition lets
% us convert these into simpler constraints that do not have $\varphi$ on the
% antecedent or into a constraint that is directly incorporated into definition
% of $\predSubstFn$.
\end{proof}

