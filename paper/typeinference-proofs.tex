\newcommand{\deltaPC}{\Delta_P^C}

\section{Type Inference: Proofs}

\begin{theorem}
\label{thm:constraint-generation-sc}
Let $C = \consOf{q}$.
An assignment $\soln$ (for the region and predicate variables in $q$)
satisfies $C$ iff $q[\soln]$ is well-typed.
\end{theorem}
\begin{proof}
The correspondence between the static semantics rules and the constraint generation
rules induces a correspondence between derivation trees produced by the
two systems.
% We do not present a formal proof of the theorem.
We can establish the following lemma inductively:
given a derivation tree $\zeta_1$ for
$\exprok {\stdcontext}{e}{\tau}{C}$
and any substitution $\soln$,
we can construct a corresponding \emph{candidate} derivation
tree $\zeta_2$ of $\hastyp {\A[\soln],\env[\soln]}{e[\soln]}{\tau[\soln]}$.
We can show that $\zeta_2$ is a valid derivation tree iff $\soln$ satisfies $C$.
(We make use of analogous lemmas for type well-formedness rules as well.)
\end{proof}

\begin{lemma}
  \label{lemma:gc-is-decomposable}
  Let $C = \consOf{q}$. Every abduction constraint in $C$ is decomposable.
\end{lemma}

\begin{proof}
  By induction over the constraint-generation rules.
  Any context $\A = (\rhoenv,\aenv,\phicx)$ generated by the constraint-generation
  process satisfies the invariant that $\phicx$ is of the form $\varphi \conj \phictxt$
  where $\rhoenv \supseteq \predDeltaMap(\varphi)$.
  The only rule that modifies $\phicx$ is the rule for \C{letregion}
  that adds the set of constraints $\pi_f \outlives \pi$ for every $\pi_f \in \rhoenv$
  as conjuncts to $\phicx$.
\end{proof}

We recall the definition of $\predDeltaMap(\varphi)$ first. We work with sets of constraints $C$ that
contain exactly only constraint of the form  $\tywf{\Delta}{\varphi}$ for any predicate variable $\varphi$
and we refer to this $\Delta$ as $\predDeltaMap(\varphi)$. In the sequel, we use the notation
$\deltaPC(\varphi)$ to clarify the dependence on $C$, and will omit the superscript if no confusion
is likely.

\begin{lemma}
  \label{lemma:decomposition}
Consider any decomposable constraint  $\isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j}$
where both $\pi_i$ and $\pi_j$ are region constants.
(a) If $\{ \pi_i, \pi_j \} \subseteq \deltaPC(\varphi)$,
then $\soln$ satisfies $C \cup \{ \isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j} \}$
iff
$\soln$ satisfies $C \cup \{ \isvalid{\varphi}{\pi_i \outlives \pi_j} \}$
  (b) If $\{ \pi_i, \pi_j \} \not \subseteq \deltaPC(\varphi)$,
$\soln$ satisfies $C \cup \{ \isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j} \}$
iff
$\soln$ satisfies $C \cup \{ \isvalid{\phi}{\pi_i \outlives \pi_j} \}$
\end{lemma}

\begin{proof}
  Let $\soln$ be any assignment that satisfies $C$.
  Let $\phi'$ denote $\solnP(\varphi)$.
  The lemma follows once we show that
  $\isvalid{\phi' \conj \phi}{\pi_i \outlives \pi_j}$ iff
  $\isvalid{\phi'}{\pi_i \outlives \pi_j}$ or
  $\isvalid{\phi}{\pi_i \outlives \pi_j}$.
  The reverse implication is trivial, and we establish the forward implication below.

  Assume that $\isvalid{\phi' \conj \phi}{\pi_i \outlives \pi_j}$.
  Recall that we can represent $\phi' \conj \phi$ as a graph, with each vertex
  representing a region identifier, and each outlives-constraint $\pi \outlives \pi'$
  represented as an edge from $\pi$ to $\pi'$. Further,
  $\isvalid{\phi' \conj \phi}{\pi_i \outlives \pi_j}$ holds iff there exists a path
  from $\pi_i$ to $\pi_j$ in this graph.

  Let $\Delta$ denote $\deltaPC(\varphi)$.
  Clearly, $\phi'$ can include an outlives-constraint $\pi \outlives \pi'$ only if
  $\{ \pi, \pi' \} \subseteq \Delta$.
  Thus, $\phi'$ represents a set of edges between vertices in $\Delta$.
  On the other hand, $\phi$ represents a set of edges whose targets are outside $\Delta$
  (from the definition of a decomposable constraint).
  Furthermore, it follows from the definition of a decomposable constraint that
  if $\phi$ includes an outlives-constraint $\pi \outlives \pi'$ for some $\pi \in \Delta$,
  then $\phi$ includes the outlives-constraint $\pi'' \outlives \pi'$ for every $\pi'' \in \Delta$.

  The result follows.
\end{proof}

\begin{theorem}
  \label{thm:closure}
Let $C = \consOf{q}$.
An assignment $\soln$ satisfies $C$ iff $\soln$ satisfies $\satC$.
\end{theorem}

\begin{proof}
  For the forward implication, we use induction to show that every constraint
  added to $\satC$ preserves satisfiability (with respect to an assignment $\soln$).
  The Transitivity and Substitution steps are straightforward. The Abduction Decomposition
  step is justified by Lemmas~\ref{lemma:gc-is-decomposable} and~\ref{lemma:decomposition}.
  The reverse implication is trivial.
\end{proof}

\begin{lemma}
  \label{lemma:completely-bound}
Let $C = \consOf{q}$. If $\satC$ is satisfiable, then
every region variable occurring in $\satC$ is bound to some region constant in $\satC$.
\end{lemma}

\begin{proof}
Intuitively, the lemma says that every region variable will be unified with
some region constant (by the generated constraints).
There is one special case where this does not hold: a recursive function
that calls itself in a non-terminating fashion. Such a function never
returns a value, and so the return-value can be typed as anything.
We assume that the return value of such a function is typed to be \C{unit},
which will not introduce any region variables at the call-site of such a function.

This property follows from several aspects of $\FB$, e.g., it does not admit uninitialized variables.
Note that the region \C{R} where a new object is allocated (by the \C{new} construct) is indicated
by the user (as \C{new@R}). If the user does not specify this, it defaults to the allocation
context region. Thus, this aspect is handled by the frontend, and does not require or use
the constraint solver.

% This property follows from the constraint-generation rules.
% , and the type system uniquely determines the region parameters of every value
\end{proof}

\begin{lemma}
  \label{lemma:two-bindings}
Let $C = \consOf{q}$. Assume that $\groundC$ is valid.
Suppose a region variable $\rho$ is bound to two different region constants $\pi_1$
and $\pi_2$ in a context $\varphi \conj \phi$. % in $\satC$.
% Let $\soln$ satisfy $\satC$.
% For any context $\varphi \conj \phi$ that contains $\rho$, we must have
Then, 
(a) $\{ \pi_1, \pi_2 \} \subseteq \predDeltaMap(\varphi)$,
(b) $\isvalid{\thesolnP(\varphi)}{\pi_1 = \pi_2}$.
(c) For any $\soln$ that satisfies $\satC$, we must have $\isvalid{\solnP(\varphi)}{\pi_1 = \pi_2}$.
\end{lemma}

\begin{proof}
  Assume that a region variable $\rho$ is bound to two different
  region constants $\pi_1$ and $\pi_2$ in a context $\varphi \conj \phi$.
  By transitivity, $\satC$ is guaranteed to have the constraints
  $\isvalid{\varphi \conj \phi}{\pi_1 \outlives \pi_2}$
  and $\isvalid{\varphi \conj \phi}{\pi_2 \outlives \pi_1}$.
  By abduction decomposition, one of the following conditions must hold:
  (a) $\{ \pi_1, \pi_2 \} \subseteq \predDeltaMap(\varphi)$ and
  both $\isvalid{\varphi}{\pi_1 \outlives \pi_2}$ and
  $\isvalid{\varphi}{\pi_2 \outlives \pi_1}$ are in $\satC$, or
  (b) $\{ \pi_1, \pi_2 \} \not\subseteq \predDeltaMap(\varphi)$ and
  both $\isvalid{\phi}{\pi_1 \outlives \pi_2}$ and
  $\isvalid{\phi}{\pi_2 \outlives \pi_1}$ are in $\satC$.
  In case (b), $\satC$ will not be satisfiable, so we can ignore this case.
  In case (a), $\varphi$ must be bound to a conjunction that includes both
  $\pi_1 \outlives \pi_2$ and $\pi_2 \outlives \pi_1$ in any satisfying assignment
  for $\satC$.
\end{proof}

% \begin{lemma}
% Let $C = \consOf{q}$.
% Let $\satC_1$ denote the subset of $\satC$ obtained by removing all constraints
% that contain a region variable.
% $\satC$ is satisfiable iff $\satC_1$ is satisfiable.
% \end{lemma}
% 
% \begin{proof}
%   The forward implication is trivial.
%   The reverse implication follows from Lemma~\label{lemma:completely-bound}, as shown below.
% \end{proof}

\begin{theorem}
\label{thm:constraint-solver-soundness}
Let $C = \consOf{q}$.
If $\solveCon{C} = \textsc{Some}(\soln)$,
then $\soln$ satisfies $\satC$.
\end{theorem}

\begin{proof}
Assume $\solveCon{C} = \textsc{Some}(\soln)$.

By definition (of $\solveCon{C}$), $\groundC$ (the set of all variable-free constraints in $\satC$)
is satisfiable. Hence, $\soln$ trivially satisfies all constraints in $\groundC$.
%
The definition also ensures that $\soln$ satisfies the well-formedness constraints
for any region variable $\rho$.

Consider any constraint of the form $\isvalid{\varphi}{\pi_i \outlives \pi_j}$ in $\satC$,
where $\pi_i$ and $\pi_j$ are distinct region constants. The definition of $\solnP(\varphi)$
ensures that $\soln$ satisfies this constraint.
Furthermore, $\soln$ must also satisfy the well-formedness constraint
$\tywf{\predDeltaMap(\varphi)}{\varphi}$.
(Otherwise, the application of Abduction Decomposition to this constraint will add
$\isvalid{}{\pi_i \outlives \pi_j}$ to $\satC$. This constraint is invalid, which
contradicts the fact that $\groundC$ is valid.)

Consider any constraint of the form $\isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j}$ in $\satC$,
It follows from abduction decomposition that either
$\isvalid{\varphi}{\pi_i \outlives \pi_j}$
or
$\isvalid{\phi}{\pi_i \outlives \pi_j}$ must be in $\satC$, which we know is satisfied by $\soln$.
Hence, $\soln$ must satisfy
$\isvalid{\varphi \conj \phi}{\pi_i \outlives \pi_j}$ as well.

This shows that $\soln$ satisfies all outlives-constraints in $\satC$ that have no variables in the consequent.

Consider any constraint of the form $\isvalid{\ell}{F_j(\varphi_j)}$.
Substituting the value $\solnP(\varphi_j)$ reduces this constraint to one of
the form $\isvalid{\ell}{\conj_i \pi_i \outlives \pi_i'}$ where the substitution rule
guarantees $\isvalid{\ell}{\pi_i \outlives \pi_i'}$ is already in $\satC$ and, hence,
satisfied by $\soln$.
Hence, $\soln$ satisfies $\isvalid{\ell}{F_j(\varphi_j)}$ as well.

Consider any constraint of the form $\isvalid{\ell}{r}$ where $r$ contains a single occurrence
of a region variable, say $\rho$.
It follows from Lemma~\ref{lemma:completely-bound} that $\rho$ is bound to some region
constant $\pi$.
Let $r'$ denote $r$ with $\rho$ replaced by $\pi$.
It follows from the transitivity rule that $\satC$ must contain the constraint $\isvalid{\ell}{r'}$.
Since this constraint has no variables on the consequent, we have already shown that $\soln$
must satisfy this constraint ($\isvalid{\ell}{r'}$).
Let $\pi' = \solnR(\rho)$.
We can show (using Lemma~\ref{lemma:two-bindings}) that $\soln$ satisfies $\isvalid{\ell}{\pi = \pi'}$.
Hence, $\soln$ satisfies $\isvalid{\ell}{r}$ as well.

The same idea works for constraints with occurrences of two region variables in the consequent.

\end{proof}

\begin{theorem}
\label{thm:constraint-solver-completeness}
Let $C = \consOf{q}$.
If $\solveCon{C} = \textsc{None}$, then $C$ is unsatisfiable.
\end{theorem}

\begin{proof}
We prove the theorem by contradiction.
Assume that $\satC$ is satisfiable.
We will show that the precondition for the first case in the definition of $\textsc{Solve}$
holds and, hence, $\solveCon{C}$ cannot be $\textsc{None}$.

Since $\satC$ is satisfiable, $\groundC$ is trivially valid.
We just need to show that $\thesolnR$ satisfies $\rhoC$.
Recall that $\rhoC$ is the subset of $C$ of well-formedness constraints
on region variables.
So, we just need to show for any constraint $\rho \in \rhoenv$ in $C$ that
$\thesolnR(\rho) \in \rhoenv$.
Since we have assumed that $\satC$ is satisfiable, there exists some $\soln$ that satisfies $\satC$
and, in particular, the constraint $\rho \in \rhoenv$.
Let $\pi$ denote $\soln(\rho)$. Thus, we have $\pi \in \rhoenv$.

Let $\hat{\pi}$ denote $\thesolnR(\rho)$. If $\pi$ and $\hat{\pi}$ are the same region
constant, then $\hat{\pi}\ \in \rhoenv$ and the proof is complete.
%
Otherwise, it follows from the definition of $\thesoln$, that we have some constraint
$\isvalid{\varphi \conj \phi}{\rho = \hat{\pi}}$ in $\satC$.
Since $\soln$ satisfies this constraint, we have
$\isvalid{\solnP(\varphi) \conj \phi}{\pi = \hat{\pi}}$.
We can show that $\{ \pi, \hat{\pi} \} \subseteq \predDeltaMap(\varphi)$
(as in the proof of Lemma~\ref{lemma:two-bindings}).
We can show, by induction over the constraint-generation rules, that if $\Delta$
includes some element of $\predDeltaMap(\varphi)$, then it includes all elements of $\predDeltaMap(\varphi)$.
Hence, it follows that $\hat{\pi} \in \Delta$.
% for some predicate variable $\varphi$.


% If $\groundC$ is satisfiable, the solver will fail to return an assignment only if the set $S_\rho$ = 
% $\{ \pi \in \regionDeltaMap(\rho) \; | \; \isvalid{\ell}{\rho = \pi} \in \satC \}$ is empty for some region variable $\rho$.
% Consider any such $\rho$.
% Let $\soln$ be a satisfying assignment for $\satC$.
% Let $\pi' = \solnP(\rho)$. Then, we must have $\pi' \in \regionDeltaMap(\rho)$.
% From Lemma~\ref{lemma:completely-bound}, $\rho$ must be bound to some $\pi$ in some context $\ell$.
% Thus, $\isvalid{\ell}{\rho = \pi} \in \satC$.
% Since $\soln$ satisfies this constraint, we have $\isvalid{\ell[\soln]}{\pi' = \pi}$.
% If $\pi$ and $\pi'$ are the same region identifier, we have a contradiction, since
% $\pi \in S_\rho$ and $S_\rho$ cannot be empty.
% If $\pi$ and $\pi'$ are distinct region identifiers, then it follows that the precondition of case (a) must hold
% in Lemma~\ref{lemma:decomposition}, and we must have $\{ \pi, \pi' \} \subseteq \predDeltaMap(\varphi)$.
% We can show, by induction over the constraint-generation rules, that if $\regionDeltaMap(\rho)$ includes
% some element of $\predDeltaMap(\varphi)$, then it includes all elements of $\predDeltaMap(\varphi)$.
% It follows that $\pi \in \regionDeltaMap(\rho)$. Hence, the set $S_\rho$ is non-empty (as it contains $\pi$.
% The result follows.
\end{proof}

\begin{theorem}
\label{thm:constraint-solver-sc}
Let $C = \consOf{q}$.\\
(Soundness) If $\solveCon{C} = \textsc{Some}(\soln)$, then $\soln$ satisfies $C$.\\
(Completeness) If $\solveCon{C} = \textsc{None}$, then $C$ is unsatisfiable.
\end{theorem}

\begin{proof}

Follows from Theorems~\ref{thm:constraint-solver-soundness} and~\ref{thm:constraint-solver-completeness}.

\end{proof}

