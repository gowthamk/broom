%
% LET expression
\begin{minipage}{1.8in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \hastyp{\exptycx{\env}{\rgn}}{e_1}{\tau_1}\\
    \hastyp{\exptycx{\env[x\mapsto\tau_1]}{\rgn}}{e_2}{\tau_2}\\
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}{\letexp{x}{e_1}{e_2}}{\tau_2}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{1.2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \hastyp{\exptycx{\env}{\rgn}}{\bar{e}}{\taubar} \\
    \tywf{\A}{\fbN} \spc
    \fields(\fbN) = \bar{f} : \taubar \\
  }
  {
    \hastyp{\exptycx{\env}{\rgn}}{\C{new}\; \fbN(\bar{e})}{\fbN}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
% %
% \begin{minipage}{2in}
% \begin{smathpar}
% \begin{array}{c}
% \renewcommand*{\arraystretch}{1.2}
% \RULE
%   {
%     \hastyp{\exptycx{\ralloc}{\env}}{e}{\tau'}\\
%     \bar{f}:\taubar \,=\, \fields(\bound_{\A.\aenv}(\tau'))
%   }
%   {
%     \hastyp{\exptycx{\ralloc}{\env}}{e.f_i}{\tau_i}
%   }
% \end{array}
% \end{smathpar}
% \end{minipage}
% %
%
\begin{minipage}{1.8in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \\
    \fgjtywf{\A.\aenv}{T} \spc
    \fgjN = \RgnZ\inang{T}\\
    \hastyp{(\emptyset,\{\rhoalloc\},\A.\aenv,true),{\rhoalloc},{\cdot}}{e}
      {T@\rhoalloc}
  }
  {
    \hastyp{\exptycx{\ralloc}{\env}}{\C{new}\;
    \fgjN\inang{\toprgn}(\lambdaexp{\ralloc}{\rhoalloc}{}{e})} {\fgjN\inang{\toprgn}}
  }
\end{array}
\end{smathpar}
\end{minipage}
% %
% \begin{minipage}{2.75in}
% \begin{smathpar}
% \begin{array}{c}
% \renewcommand*{\arraystretch}{1.2}
% \RULE
%   {
%     \rbar \in \A.\rhoenv \spc
%     \hastyp{\exptycx{\ralloc}{\env}}{\bar{e}}
%         {\bar{\tau}}\spc\\
%     \hastyp{\exptycx{\ralloc}{\env}}{e}
%         {\inang{\rhoalloc\rhobar \,|\, \phi}
%             \bar{\tau^1} \xrightarrow{\rgn} \tau^2}\\
%     \substFn = \subst{\rbar}{\rhobar}
%                \subst{\ralloc}{\rhoalloc} \spc
%     \isvalid{\A.\phicx}{\substFn(\phi)} \spc
%     \subtyp{\A}{\taubar}{\bar{\tau^1}}
%   }
%   {
%     \hastyp{\A,\ralloc,\env}{e\inang{\ralloc\rbar}(\bar{e})}
%            {\substFn(\tau^2)}
%   }
% \end{array}
% \end{smathpar}
% \end{minipage}
% %
% \smallskip

% LET REGION
%
\begin{minipage}{2.7in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \A = (\subtypcx) \spc
    \tywf{\A}{\tau}\\
    \phicx' = \phicx \conj (\rhoenv \outlives \rgn) \spc
    \rhoenv' =\rhoenv \cup \{\rgn\} \\
    \rgn \notin \rhoenv \spc
    \A' = (\rhoset, \rhoenv', \aenv, \phicx')\spc
    \hastyp{\A',\rgn,\env}{e}{\tau}
  }
  {
    \hastyp{\exptycx{\ralloc}{\env}}{\letregion{\rgn}{e}}{\tau}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
%
\begin{minipage}{3.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
   \hastyp{\exptycx{\ralloc}{\env}}{e_a}
            {\RgnZ\inang{T}\inang{\toprgn}}\\
    \tywf{\A}{\tau} \spc
    \A = (\subtypcx) \spc
    \rgn \notin \rhoenv \spc
    \rhoenv' = \rhoenv \cup \{\rgn\}\\
    \A' = (\rhoset, \rhoenv',\aenv,\phicx) \spc
    \env' =  \env[y\mapsto T@\rgn]\spc
    \hastyp{\A',\rgn,\env'}{e_b}{\tau} 
  }
  {
    \hastyp{\exptycx{\ralloc}{\env}}{\open{e_a}{\rgn}{y}{e_b}}
            {\tau}
  }
\end{array}
\end{smathpar}
\end{minipage}
% %
% \begin{minipage}{1.8in}
% \begin{smathpar}
% \begin{array}{c}
% \renewcommand*{\arraystretch}{1.2}
% \RULE
%   {
%     \\
%     \rgn \in \A.\rhoset\spc
%     \A' = (\{\}, \{\rgn\}, \A.\aenv, true) \\
%     \rgn \notin \A.\rhoenv \cup \{\toprgn\} \spc
%     \tywf{\A'}{T@\rgn} \spc
% %   \fgjN = \RgnZ\inang{T}\spc
%     \hastyp{\A', {\rgn},{\env}}{e}{T@\rgn}
%   }
%   {
%     \hastyp{\exptycx{\ralloc}{\env}}{\C{new}\;
%     \RgnZT{\rgn}(e)} {\RgnZT{\toprgn}}
%   }
% \end{array}
% \end{smathpar}
% \end{minipage}
% %
\begin{minipage}{3in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \A = (\subtypcx) \spc
%   \rgn \in \rhoenv \spc
    \rhoalloc,\rhobar \notin \rhoenv \\
%   \rhoenv' = \rhoenv \cup \{\rhoalloc,\rhobar\}\spc
    \rhoenv' = \rhoenv \cup \{\rhoalloc,\rhobar\}\spc
    \tywf{\rhoenv'}{\phi}\spc
    \A' = (\rhoset, \rhoenv', \aenv, \phicx \conj \phi)\\
    \tywf{\A'}{\bar{\tau^1}}\spc
    \tywf{\A'}{\tau^2}\spc
    \hastyp{\A',\rhoalloc,\env[\xbar \mapsto \bar{\tau^1}]}{e}{\tau^2}
  }
  {
    \hastyp{\exptycx{\ralloc}{\env}}
           {\lambdaexp{\ralloc}{\rhoalloc\rhobar \,|\, \phi}
                      {\xbar:\bar{\tau^1}}{e}}
           {\inang{\rhoalloc\rhobar \,|\, \phi}
            \bar{\tau^1} \xrightarrow{\ralloc} \tau^2}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
% FUNCTION APPLICATION
%
\begin{minipage}{3.5in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \rbar \in \A.\rhoenv \spc
    \hastyp{\exptycx{\ralloc}{\env}}{e}
        {\inang{\rhoalloc\rhobar \,|\, \phi}
            \bar{\tau^1} \xrightarrow{\rgn} \tau^2}\\
    \substFn = \subst{\rbar}{\rhobar}
               \subst{\ralloc}{\rhoalloc} \spc
    \isvalid{\A.\phicx}{\substFn(\phi)} \spc
    \hastyp{\exptycx{\ralloc}{\env}}{\bar{e}}
        {\substFn(\bar{\tau^1})}\spc
%   \subtyp{\A}{\taubar}{\bar{\tau^1}}
  }
  {
    \hastyp{\A,\ralloc,\env}{e\inang{\ralloc\rbar}(\bar{e})}
           {\substFn(\tau^2)}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
% METHOD INVOCATION
\begin{minipage}{3.7in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \hastyp{\exptycx{\ralloc}{\env}}{e_0}{\tau} \spc
    \rbar \in \A.\rhoenv \\
    \mtype(m,\bound_{\A.\aenv}(\tau)) = \inang{\rhoalloc\rhobar \,|\, 
        \phi}\bar{\tau^1}\rightarrow{\tau^2} \spc
    \substFn = [\rbar/\rhobar, \ralloc/\rhoalloc] \\
    \tywf{\A}{\inang{\rhoalloc\rhobar \,|\,
    \phi}\bar{\tau^1}\rightarrow{\tau^2}}\spc
%   \tywf{\A}{\substFn(\bar{\tau^1})} \spc
%   \tywf{\A}{\substFn(\tau^2)} \\
    \hastyp{\exptycx{\ralloc}{\env}}{\bar{e}}{\substFn(\bar{\tau^1})} \spc
%   \subtyp{\A}{\bar{\tau'}}{\substFn(\bar{\tau^1})} \spc
    \isvalid{\A.\phicx}{\substFn(\phi)}
  }
  {
    \hastyp{\exptycx{\ralloc}{\env}}{e_0.m\inang{\ralloc\rbar}(\bar{e})} 
           {\substFn(\tau^2)}
  }
\end{array}
\end{smathpar}
\end{minipage}
%
% TRANSFER
\begin{minipage}{2in}
\begin{smathpar}
\begin{array}{c}
\renewcommand*{\arraystretch}{1.2}
\RULE
  {
    \\
    \hastyp{\exptycx{\ralloc}{\env}}{e}{\RgnZ\inang{T}\inang{\toprgn}}
  }
  {
    \hastyp{\exptycx{\ralloc}{\env}}{e.\transfer\inang{\ralloc}()}{\unitZ}
  }
\end{array}
\end{smathpar}
\end{minipage}
%


