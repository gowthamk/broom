% \newcommand{\opsemrule}[3]{%
% \begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
% \renewcommand*{\arraystretch}{1.2}%
% \RULE {#2} {#3}%
% \end{array}\end{smathpar}\end{minipage}%
% }
% \newcommand{\lopsemrule}[4]{%
% \begin{minipage}{#1}\begin{smathpar}\begin{array}{c}%
% \renewcommand*{\arraystretch}{1.2}%
% [\rulelabel{#4}] \spc \RULE {#2} {#3}%
% \end{array}\end{smathpar}\end{minipage}%
% }
% %
% \newcommand{\anobjty}[0]{B\inang{\tbar}\inang{\ralloc\locbar}}
% \newcommand{\anobj}[0]{\C{new} \; \anobjty(\bar{v})}
% %

\begin{figure*}[t!]

%
\fbox {\(\redstoo{\Delta}{(e,\mem)}{(e',\mem')}\)}\\

\lopsemrule{\textwidth}{
    \redstoo{\Delta}{(e,\mem)}{(e',\mem')}
}{
    \redstoo{\Delta}{(E\lbrack e \rbrack, \mem)}
            {(E\lbrack e' \rbrack, \mem')}
	  }{EvalOrder}

\lopsemrule{\textwidth}{
    \redstoo{\Delta}{(e,\mem)}{\invalidexn}
  }{
    \redstoo{\Delta}{(E\lbrack e \rbrack, \mem)}
            {\invalidexn}
	  }{Exception}
%

\lopsemrule{\textwidth}{
%   \allocRgn(A\inang{\rgn\locbar}\inang{\tbar}) & = & \rgn
%   \allocRgn(\fbN) \in \rhoenv \spc
    \mem(\loc) = \LIVE \spc
    \fields(A\inang{\tbar}\inang{\loc\locbar}) = \bar{f}:\taubar
}{
    \redstoo{\Delta}{((\C{new} \; A\inang{\tbar}\inang{\loc\locbar}(\vbar)).f_i,\mem)}{(v_i,\mem)}
}{FieldAccess}

\lopsemrule{\textwidth}{
%   \allocRgn(\fbN) \in \rhoenv \spc
    \mem(\loc) = \LIVE \spc
    \mbody(m,A\inang{\tbar}\inang{\loc\locbar}) = \rho\rhobar.\bar{x}.e 
%   \redstoo{\Delta}{(, \mem)}{(e',\mem')}
}{
    \redstoo{\Delta}{((\C{new}\;A\inang{\tbar}\inang{\loc\locbar}(\bar{v})).m\inang{\loc'\overline{\loc'}}
                      (\bar{v'}),\mem)}
            {\\([\loc'\overline{\loc'}/\rho\rhobar][\bar{v'}/\xbar]
                [\C{new} \; A\inang{\tbar}\inang{\loc\locbar}(\bar{v})/\thisZ]\,e,\mem)}
	  }{MethodInv}

\lopsemrule{\textwidth}{
    v_a = \lambdaexp{\loc'}{\rho\rhobar}
                        {\taubar \; \xbar}{e} \spc
    \mem(\loc') = \LIVE  \spc 
}{
    \redstoo{\Delta}{(v_a\inang{\loc\locbar}(\bar{v}) ,\mem)}
            {([\bar{v}/\xbar][\loc\locbar/\rho\rhobar]\,e,\mem)}
	  }{FnApply}

%
% \lopsemrule{\textwidth}{
% %   \rgn \notin \rhoenv \spc
% %   \fresh(\rgn') \spc
%     \redstoo{\Delta}{(e,\mem)}{\invalidexn}
% }{
%     \redstoo{\Delta}{(\letregion{\rgn}{e},\mem)}{\invalidexn}
%   }{EXCEPTION}

\lopsemrule{\textwidth}{
%   \fgjN = \RgnZ\inang{T} \spc
%   \rgn \in dom(\mem) \spc
    \mem(\loc) = \USED \spc
    \redstocup{\loc}{(e,\mem[\loc \mapsto \LIVE])}{\invalidexn}
}{
    \redstoo{\Delta}{(\C{new} \; \RgnZT{\toploc\loc} (e),\mem)}
            {\invalidexn}
	  }{Exception}

\lopsemrule{\textwidth}{
%   \fgjN = \RgnZ\inang{T} \spc
%   \rgn \in dom(\mem) \spc
}{
    \redstoo{\Delta}{(\letexp{x}{v}{e},\mem)}
            {([v/x]e,\mem)}
	  }{LetExp}

% \lopsemrule{\textwidth}{
%     \not\exists \loc.~\mem(\loc) = \FREE
% }{
%     \redstoo{\Delta}{(\letregion{\rgn}{e},\mem)}{\invalidexn}
%   }{EXCEPTION}


% \lopsemrule{\textwidth}{
%     \not\exists \loc.~\mem(\loc) = \FREE
% }{
%     \redstoo{\Delta}{(\C{new} \; \RgnZ\inang{T}\inang{\toprgn}
%                 (\lambdaexp{\loc'}{\rho}{}{e}),\mem)}
%             {\invalidexn}
%         }{EXCEPTION}
% \lopsemrule{\textwidth}{
%     \mem(\rgn_r) \neq \XFERRED \spc
% %   \fresh(\rgn_1) \spc
% %  \rgn_0 \notin \rhoenv \\
%     \redsto{\Delta \cup \{\rgn\}}{([[\rgn/\rgn_r]v_r/x]e_b,
%       \mem[\rgn_r \mapsto \OPEN])}{\invalidexn}
% }{
%     \redstoo{\Delta}{(\open{(\C{new} \; \RgnZ\inang{T}\inang{\rgn_r}(v_r))}
%                    {\rgn}{x}{e_b},\mem)} 
%             {\invalidexn}
%     }{EXCEPTION}

%
\bigskip

\textbf{Evaluation Context} \fbox {\(E\)}\\
\begin{smathpar}
\begin{array}{lcl}
E & \coloneqq & \bullet \ALT (\bullet).f \ALT \bullet.m\inang{\locbar}(\ebar) \ALT
      v.m\inang{\locbar}(...,\bullet,...) \ALT \C{new}\;
      \fbN(...,\bullet,...) \\
  &  & \ALT \C{new} \; \RgnZ\inang{T}\inang{\toprgn}(\bullet)
       \ALT \bullet\inang{\locbar}(\ebar)\ALT
       v\inang{\locbar}(...,\bullet,...)\\
  &  & \ALT \letexp{x}{\bullet}{e} \ALT \open{\bullet}{\rgn}{y}{e} 
%      \ALT \opened{\loc}{\status}{\bullet} \ALT \letd{\loc}{\bullet}
%     The following should be forbidden. See NEW-REGION rule 2.
%      \ALT \C{new} \; \RgnZ\inang{T}\inang{\toploc\loc}(\bullet)
\end{array}
\end{smathpar}

\caption{\fbname: operational semantics (continuation of
Fig.~\ref{fig:fb-opsem})}
\label{fig:fb-opsem-1}
\end{figure*}

